<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advance Interactive Script Console</title>
    <!-- Google AdSense Account Meta Tag (Recommended in <head>) -->
    <meta name="google-adsense-account" content="ca-pub-3062851685354753">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f1eb; /* Warm Beige */
            color: #212529; /* Dark Gray for infographic text */
        }

        /* Dark mode styles */
        html.dark body {
            background-color: #1a202c; /* Dark Slate */
            color: #e2e8f0; /* Light Gray */
        }

        /* Console specific styles - Light Mode */
        .bg-primary { background-color: #f4f1eb; }
        .bg-secondary { background-color: #ffffff; }
        .text-main { color: #2d3748; } /* Slate 800 */
        .text-accent { color: #4a5568; } /* Slate 600 */
        .border-accent { border-color: #e2e8f0; /* Slate 200 */ }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #22c55e; color: white; }
        .btn-success:hover { background-color: #16a34a; }
        .btn-llm { background-color: #e0f2fe; color: #0284c7; } /* Light blue for LLM buttons */
        .btn-llm:hover { background-color: #bae6fd; }

        /* Console specific styles - Dark Mode */
        html.dark .bg-primary { background-color: #1a202c; }
        html.dark .bg-secondary { background-color: #2d3748; }
        html.dark .text-main { color: #e2e8f0; } /* Light Gray */
        html.dark .text-accent { color: #a0aec0; } /* Gray 400 */
        html.dark .border-accent { border-color: #4a5568; /* Slate 600 */ }
        html.dark .btn-primary { background-color: #4299e1; color: white; }
        html.dark .btn-primary:hover { background-color: #3182ce; }
        html.dark .btn-secondary { background-color: #718096; color: white; }
        html.dark .btn-secondary:hover { background-color: #5a67d8; }
        html.dark .btn-danger { background-color: #fc8181; color: white; }
        html.dark .btn-danger:hover { background-color: #e53e3e; }
        html.dark .btn-success { background-color: #68d391; color: white; }
        html.dark .btn-success:hover { background-color: #38a169; }
        html.dark .btn-llm { background-color: #90cdf4; color: #1a202c; } /* Lighter blue for LLM buttons */
        html.dark .btn-llm:hover { background-color: #63b3ed; }

        /* Chart container for console charts */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 40vh;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        #live-log {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-success { color: #22c55e; }
        .log-error { color: #ef4444; }
        .log-info { color: #3b82f6; }
        .log-warning { color: #f59e0b; }
        .log-skipped { color: #a8a29e; }
        .log-neutral { color: #a8a29e; } /* Added for idle messages */
        html.dark .log-success { color: #68d391; }
        html.dark .log-error { color: #fc8181; }
        html.dark .log-info { color: #90cdf4; }
        html.dark .log-warning { color: #fbd38d; }
        html.dark .log-skipped { color: #cbd5e0; }
        html.dark .log-neutral { color: #cbd5e0; }

        .log-copy-btn {
            background: none;
            border: none;
            color: #a8a29e; /* Gray */
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 5px;
            padding: 0 3px;
            vertical-align: middle;
            transition: color 0.2s;
        }
        .log-copy-btn:hover {
            color: #e2e8f0; /* Lighter gray on hover */
        }
        html.dark .log-copy-btn { color: #a0aec0; }
        html.dark .log-copy-btn:hover { color: #e2e8f0; }


        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-container .tooltip-text {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position above the text */
            left: 50%;
            margin-left: -75px; /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            width: 150px;
        }

        .tooltip-container .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%; /* At the bottom of the tooltip */
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        html.dark .modal-content {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        .close-button, .close-qr-button, .close-confirm-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus,
        .close-qr-button:hover,
        .close-qr-button:focus,
        .close-confirm-button:hover,
        .close-confirm-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        html.dark .close-button, html.dark .close-qr-button, html.dark .close-confirm-button {
            color: #cbd5e0;
        }
        html.dark .close-button:hover, html.dark .close-button:focus,
        html.dark .close-qr-button:hover, html.dark .close-qr-button:focus,
        html.dark .close-confirm-button:hover, html.dark .close-confirm-button:focus {
            color: #e2e8f0;
        }

        .modal-loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        html.dark .modal-loader {
            border-color: #4a5568;
            border-top-color: #4299e1;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Disabled styles for fields */
        .wallet-feature-control:disabled,
        .wallet-feature-control[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #e2e8f0; /* Light gray */
        }
        html.dark .wallet-feature-control:disabled,
        html.dark .wallet-feature-control[disabled] {
            background-color: #4a5568; /* Darker gray */
            color: #cbd5e0;
        }

        /* --- MODIFIED: Hover-expanding Sidebar Navigation --- */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 80px; /* Collapsed width */
            background-color: #ffffff; /* White background */
            color: #2d3748; /* Dark text color */
            padding-top: 1rem;
            transition: width 0.3s ease-in-out;
            z-index: 50;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); /* Softer shadow */
            overflow-x: hidden; /* Hide overflowing content */
            border-right: 1px solid #e2e8f0; /* Add a subtle border */
        }
        html.dark #sidebar {
            background-color: #2d3748;
            color: #e2e8f0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.3);
            border-right: 1px solid #4a5568;
        }

        #sidebar:hover {
            width: 250px; /* Expanded width */
        }
        
        #sidebar .logo-container {
            transition: justify-content 0.3s ease-in-out;
        }
        #sidebar:hover .logo-container {
            justify-content: flex-start;
        }

        #sidebar .nav-link, #sidebar .submenu-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem 1.5rem;
            color: #4a5568;
            font-weight: 600;
            text-decoration: none;
            transition: background-color 0.2s ease, color 0.2s ease, justify-content 0.3s ease-in-out;
            white-space: nowrap;
            cursor: pointer;
        }
        html.dark #sidebar .nav-link, html.dark #sidebar .submenu-toggle {
            color: #a0aec0;
        }
        html.dark #sidebar .nav-link:hover, html.dark #sidebar .submenu-toggle:hover {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        html.dark #sidebar .nav-link.active, html.dark #sidebar .submenu-toggle.active {
            background-color: #4299e1;
            color: white;
        }
        
        #sidebar:hover .nav-link, #sidebar:hover .submenu-toggle {
            justify-content: flex-start;
        }

        #sidebar .nav-link i, #sidebar .submenu-toggle i {
            min-width: 24px;
            text-align: center;
            font-size: 1.25rem;
        }

        #sidebar .nav-text {
            opacity: 0;
            max-width: 0;
            overflow: hidden;
            white-space: nowrap;
            margin-left: 0;
            transition: opacity 0.2s ease-in-out, max-width 0.3s ease-in-out, margin-left 0.3s ease-in-out;
            transition-delay: 0.1s;
        }

        #sidebar:hover .nav-text {
            opacity: 1;
            max-width: 200px; /* Allow text to appear */
            margin-left: 0.75rem;
        }

        /* Submenu styles */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            background-color: #f8fafc; /* Slightly different bg for submenu */
        }
        html.dark .submenu {
            background-color: #1a202c;
        }
        
        .submenu.open {
            max-height: 500px; /* Large enough to show all items */
        }

        .submenu .nav-link {
            padding-left: 3.5rem; /* Indent submenu items */
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .submenu-toggle .fa-chevron-down {
            margin-left: auto;
            transition: transform 0.3s ease;
        }
        
        .submenu-toggle.active .fa-chevron-down {
            transform: rotate(180deg);
        }

        header, main, footer {
            margin-left: 80px;
            transition: margin-left 0.3s ease-in-out;
        }

        #sidebar:hover ~ header,
        #sidebar:hover ~ main,
        #sidebar:hover ~ footer {
            margin-left: 250px;
        }

        /* Dropdown for download log */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        html.dark .dropdown-content {
            background-color: #2d3748;
        }

        .dropdown-content button {
            color: #2d3748;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
        }
        html.dark .dropdown-content button {
            color: #e2e8f0;
        }

        .dropdown-content button:hover {
            background-color: #f1f1f1;
        }
        html.dark .dropdown-content button:hover {
            background-color: #4a5568;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-primary text-main">
    <!-- Google AdSense Script (Recommended right after <body> tag) -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3062851685354753"
     crossorigin="anonymous"></script>

    <!-- Sidebar Navigation -->
    <div id="sidebar">
        <div class="p-4 mt-8 flex items-center justify-center logo-container">
            <img src="https://d.cess.network/n1/1075188011.png" alt="FarmLabs Logo" class="h-10 w-10 rounded-full">
            <h2 class="text-xl font-bold text-gray-800 nav-text">FarmLabs</h2>
        </div>
        <nav class="flex flex-col mt-4">
            <a href="index.html" class="nav-link"><i class="fas fa-home"></i><span class="nav-text">Home</span></a>
            
            <!-- Basic Console Link (Activated) -->
            <a href="basic.html" class="nav-link"><i class="fas fa-terminal"></i><span class="nav-text">Basic Console</span></a>

            <!-- Advance Console Submenu -->
            <div>
                <div id="advance-console-toggle" class="submenu-toggle">
                    <i class="fas fa-tools"></i>
                    <span class="nav-text">Advance Console</span>
                    <i class="fas fa-chevron-down text-xs nav-text"></i>
                </div>
                <div id="advance-console-submenu" class="submenu">
                    <a href="#dashboard" class="nav-link" data-section="dashboard"><i class="fas fa-tachometer-alt"></i><span class="nav-text">Dashboard</span></a>
                    <a href="#wallets" class="nav-link" data-section="wallets"><i class="fas fa-wallet"></i><span class="nav-text">Wallets</span></a>
                    <a href="#recipient-settings" class="nav-link" data-section="recipients"><i class="fas fa-users"></i><span class="nav-text">Recipients</span></a>
                    <a href="#config" class="nav-link" data-section="configuration"><i class="fas fa-cogs"></i><span class="nav-text">Configuration</span></a>
                    <a href="#log" class="nav-link" data-section="live-log"><i class="fas fa-stream"></i><span class="nav-text">Live Log</span></a>
                </div>
            </div>

            <hr class="border-gray-300 my-2 mx-4">
            <a href="infographic.html" class="nav-link"><i class="fas fa-chart-pie"></i><span class="nav-text">Infographic</span></a>
            <a href="doc.html" class="nav-link"><i class="fas fa-file-alt"></i><span class="nav-text">Documentation</span></a>
        </nav>
    </div>

    <header class="bg-secondary shadow-md sticky top-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <!-- Header Title -->
                    <h1 class="text-xl md:text-2xl font-bold text-main ml-4">Advance Interactive Script Console</h1>
                </div>

                <!-- Right-side icons -->
                <div class="flex items-center space-x-4">
                     <a href="https://farm-labs.blogspot.com/" target="_blank" rel="noopener noreferrer" class="text-accent hover:text-blue-500" title="Farm Labs Blog">
                        <i class="fab fa-blogger text-xl"></i>
                    </a>
                    <a href="https://t.me/farm_lab" target="_blank" rel="noopener noreferrer" class="text-accent hover:text-blue-500" title="Farm Lab Telegram">
                        <i class="fab fa-telegram text-xl"></i>
                    </a>
                    <a href="https://github.com/CryptoExplor/farmlabs" target="_blank" rel="noopener noreferrer" class="text-accent hover:text-blue-500" title="Farm Labs GitHub">
                        <i class="fab fa-github text-xl"></i>
                    </a>
                    <!-- Dark Mode Toggle -->
                    <button id="theme-toggle" class="text-accent hover:text-blue-500 p-2 rounded-full transition-colors duration-200" title="Toggle Dark Mode">
                        <i class="fas fa-moon text-xl" id="theme-toggle-icon"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="p-4 sm:p-6 lg:p-8">
        <div class="container mx-auto">
            <h2 class="text-3xl md:text-4xl font-extrabold text-center mb-6" style="color: #0077B6;">Farm smarter, not harder ‚Äî with FarmLabs.</h2>

            <!-- Script Console Content -->
            <div id="script-console-content">
                <div id="security-warning" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-8 rounded-r-lg" role="alert">
                    <p class="font-bold">Security Warning</p>
                    <p>Pasting your private keys or sensitive contract ABIs into a website is extremely risky and can result in loss of funds. This application is a client-side tool for demonstration purposes only. Use it with test keys and on test networks. Never use it with mainnet keys holding real assets.</p>
                </div>

                <!-- Dashboard Section -->
                <section id="dashboard" class="mb-12">
                    <h2 class="text-3xl font-bold mb-2 text-main">Dashboard</h2>
                    <p class="text-accent mb-6">Start, stop, and monitor the Blockchain Interaction process from here, with real-time updates on wallet balances and action distribution.</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-secondary p-6 rounded-lg shadow-md flex flex-col items-center justify-center space-y-4">
                            <button id="connect-wallet-btn" class="w-full py-3 px-4 rounded-lg font-semibold transition-all duration-300 btn-success">üîó Connect Wallet</button>
                            <div id="wallet-status-display" class="text-center text-sm font-medium text-main">
                                No wallet connected.
                            </div>
                            <button id="start-btn" class="w-full py-3 px-4 rounded-lg font-semibold transition-all duration-300 btn-primary wallet-feature-control" disabled>‚ñ∂Ô∏è Start Interaction</button>
                            <button id="stop-btn" class="w-full py-3 px-4 rounded-lg font-semibold transition-all duration-300 btn-danger wallet-feature-control" disabled>‚èπÔ∏è Stop Interaction</button>
                            <button id="clear-all-data-btn" class="w-full py-2 px-4 rounded-lg font-semibold transition-all duration-300 btn-secondary wallet-feature-control" disabled>üóëÔ∏è Clear All Data</button>
                            <!-- NEW: Export/Import Contract Memory Buttons -->
                            <button id="export-contract-memory-btn" class="w-full py-2 px-4 rounded-lg font-semibold transition-all duration-300 btn-secondary wallet-feature-control" disabled>üì§ Export Contract Memory</button>
                            <input type="file" id="import-contract-memory-input" accept=".json" class="hidden" />
                            <button id="import-contract-memory-btn" class="w-full py-2 px-4 rounded-lg font-semibold transition-all duration-300 btn-secondary wallet-feature-control" disabled>üì• Import Contract Memory</button>
                        </div>
                         <div class="bg-secondary p-6 rounded-lg shadow-md col-span-1 md:col-span-2">
                            <h3 class="font-bold text-lg mb-4 text-main">Live Status</h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium text-accent">Total Actions Performed</span>
                                        <span id="progress-text" class="text-sm font-medium text-accent">0</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-4">
                                        <div id="progress-bar" class="bg-blue-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                                    <div class="p-3 bg-blue-50 rounded-lg">
                                        <div class="text-xs text-blue-500 font-bold uppercase">Status</div>
                                        <div id="status-display" class="text-lg font-semibold text-main">Idle</div>
                                    </div>
                                    <div class="p-3 bg-green-50 rounded-lg">
                                        <div class="text-xs text-green-500 font-bold uppercase">Successful Actions</div>
                                        <div id="success-count" class="text-lg font-semibold text-main">0</div>
                                    </div>
                                    <div class="p-3 bg-red-50 rounded-lg">
                                        <div class="text-xs text-red-500 font-bold uppercase">Failed Actions</div>
                                        <div id="fail-count" class="text-lg font-semibold text-main">0</div>
                                    </div>
                                    <div class="p-3 bg-gray-100 rounded-lg">
                                        <div class="text-xs text-gray-500 font-bold uppercase">Current Gas</div>
                                        <div id="gas-display" class="text-lg font-semibold text-main">N/A</div>
                                    </div>
                                </div>
                                <!-- NEW: Last Human-like Spike Indicator -->
                                <div class="p-3 bg-purple-50 rounded-lg text-center">
                                    <div class="text-xs text-purple-500 font-bold uppercase">Last Human-like Spike</div>
                                    <div id="human-spike-display" class="text-lg font-semibold text-main">Never</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-secondary p-6 rounded-lg shadow-md lg:col-span-2">
                            <h3 class="font-bold text-lg mb-4 text-main">Wallet Balances (ETH)</h3>
                            <p class="text-sm text-accent mb-4">This chart shows the current balance of each loaded wallet, dynamically updating after transactions.</p>
                            <div class="chart-container">
                                <canvas id="wallet-balance-chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-secondary p-6 rounded-lg shadow-md">
                            <h3 class="font-bold text-lg mb-4 text-main">Action Distribution</h3>
                            <p class="text-sm text-accent mb-4">Visualizes the types of actions performed (send, idle).</p>
                            <div class="chart-container">
                                <canvas id="action-dist-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Wallet Section -->
                <section id="wallets" class="mb-12">
                    <h2 class="text-3xl font-bold mb-2 text-main">Wallets</h2>
                    <p class="text-accent mb-6">Load your source wallets by pasting private keys below. Ensure you have sufficient balance for transactions.</p>
                    <div class="bg-secondary p-8 rounded-lg shadow-md mb-8">
                        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-3 mb-4 rounded-r-lg" role="alert">
                            <p class="font-bold text-sm">Important Security Reminder:</p>
                            <p class="text-xs italic">Only use test keys on testnets for this application. Never use mainnet private keys holding real funds.</p>
                        </div>
                        <label for="private-keys" class="block font-medium mb-1 text-accent">Private Keys (one per line)</label>
                        <textarea id="private-keys" rows="5" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition font-mono text-sm wallet-feature-control" disabled></textarea>
                        <button id="load-keys-btn" class="mt-4 w-full py-2 px-4 rounded-lg font-semibold transition-all duration-300 btn-secondary wallet-feature-control" disabled>Load Wallets & Check Balances</button>
                        <p id="keys-loaded-count" class="text-sm text-green-600 mt-2 font-medium"></p>
                    </div>

                    <h3 class="text-2xl font-bold mb-2 text-main">Loaded Wallets</h3>
                    <p class="text-accent mb-6">Overview of all wallets currently loaded in the application.</p>
                    <div class="bg-secondary p-6 rounded-lg shadow-md">
                        <ul id="wallet-list-display" class="list-disc pl-5 space-y-2 text-sm text-accent">
                            <li id="no-wallets-msg">No wallets loaded yet.</li>
                        </ul>
                    </div>
                </section>

                <!-- Recipient Section - Kept separate for clarity on dynamic scanning -->
                <section id="recipient-settings" class="mb-12">
                    <h2 class="text-3xl font-bold mb-2 text-main">Recipient Settings</h2>
                    <p class="text-accent mb-6">Choose how the script will select destination addresses for transactions.</p>
                    <div class="bg-secondary p-8 rounded-lg shadow-md">
                        <div class="space-y-4">
                            <label class="flex items-center">
                                <input type="radio" name="recipient-mode" value="pool" class="form-radio h-5 w-5 text-blue-600 wallet-feature-control" checked disabled>
                                <span class="ml-3 text-main">Use Dynamically Scanned Pool</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="recipient-mode" value="fixed" class="form-radio h-5 w-5 text-blue-600 wallet-feature-control" disabled>
                                <span class="ml-3 text-main">Use Fixed Address</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="recipient-mode" value="list" class="form-radio h-5 w-5 text-blue-600 wallet-feature-control" disabled>
                                <span class="ml-3 text-main">Use Custom List of Addresses (one per line)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="recipient-mode" value="predefined" class="form-radio h-5 w-5 text-blue-600 wallet-feature-control" disabled>
                                <span class="ml-3 text-main">Use Predefined List of Addresses (from CSV)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="recipient-mode" value="self-interact" class="form-radio h-5 w-5 text-blue-600 wallet-feature-control" disabled>
                                <span class="ml-3 text-main">Use Loaded Wallets to Interact with Each Other</span>
                            </label>
                        </div>

                        <div id="fixed-address-section" class="mt-4 hidden">
                            <label for="fixed-address" class="block font-medium mb-1 text-accent">Fixed Recipient Address</label>
                            <input type="text" id="fixed-address" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition font-mono text-sm wallet-feature-control" placeholder="0x..." disabled>
                        </div>

                        <div id="list-addresses-section" class="mt-4 hidden">
                            <label for="list-addresses" class="block font-medium mb-1 text-accent">Recipient Addresses (one per line)</label>
                            <textarea id="list-addresses" rows="5" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition font-mono text-sm wallet-feature-control" placeholder="0x...&#10;0x...&#10;... (one address per line)" disabled></textarea>
                            <button id="load-addresses-from-list-btn" class="mt-4 w-full py-2 px-4 rounded-lg font-semibold transition-all duration-300 btn-secondary wallet-feature-control" disabled>Load Addresses from List</button>
                            <p id="list-addresses-count" class="text-sm text-green-600 mt-2 font-medium"></p>
                        </div>

                        <div id="predefined-addresses-section" class="mt-4 hidden">
                            <p class="block font-medium mb-1 text-accent">Download list here:</p>
                            <ul class="list-disc pl-5 mb-4 text-sm text-blue-700">
                                <li><a href="https://d.cess.network/n1/812192221.csv" target="_blank" class="hover:underline">Link 1 (recipients1)</a></li>
                                <li><a href="https://d.cess.network/n1/1394676302.csv" target="_blank" class="hover:underline">Link 2 (recipients2)</a></li>
                                <li><a href="https://d.cess.network/n1/1338053122.csv" target="_blank" class="hover:underline">Link 3 (recipients3)</a></li>
                                <li><a href="https://d.cess.network/n1/738595260.csv" target="_blank" class="hover:underline">Link 4 (recipients4)</a></li>
                                <li><a href="https://d.cess.network/n1/1213534582.csv" target="_blank" class="hover:underline">Link 5 (recipients5)</a></li>
                                <li><a href="https://d.cess.network/n1/1210782270.csv" target="_blank" class="hover:underline">Link 6 (recipients6)</a></li>
                                <li><a href="https://d.cess.network/n1/1179652688.csv" target="_blank" class="hover:underline">Link 7 (recipients7)</a></li>
                                <li><a href="https://d.cess.network/n1/645402960.csv" target="_blank" class="hover:underline">Link 8 (recipients8)</a></li>
                                <li><a href="https://d.cess.network/n1/1006375340.csv" target="_blank" class="hover:underline">Link 9 (recipients9)</a></li>
                                <li><a href="https://d.cess.network/n1/1249120790.csv" target="_blank" class="hover:underline">Link 10 (recipients10)</a></li>
                                <li><a href="https://d.cess.network/n1/892015044.csv" target="_blank" class="hover:underline">Link 11 (recipients11)</a></li>
                                <li><a href="https://d.cess.network/n1/1174737402.csv" target="_blank" class="hover:underline">Link 12 (recipients12)</a></li>
                            </ul>

                            <label for="predefined-file-input" class="block font-medium mb-1 text-accent">Or Upload Your Own Predefined List (CSV)</label>
                            <input type="file" id="predefined-file-input" accept=".csv" class="w-full p-2 border border-accent rounded-md mb-2 wallet-feature-control" disabled>
                            <button id="load-predefined-file-btn" class="mt-2 w-full py-2 px-4 rounded-lg font-semibold transition-all duration-300 btn-secondary wallet-feature-control" disabled>Load Predefined Addresses from CSV</button>
                            <p id="predefined-addresses-info" class="text-sm text-gray-500 mt-1">No file loaded.</p>
                            <ul id="predefined-addresses-display" class="list-disc pl-5 space-y-1 text-sm text-accent max-h-32 overflow-y-auto mt-2">
                                <!-- Predefined addresses will be populated here -->
                            </ul>
                            <p id="predefined-addresses-count" class="text-sm text-green-600 mt-2 font-medium"></p>
                        </div>
                    </div>
                </section>

                <!-- Configuration Section -->
                <section id="config" class="mb-12">
                    <h2 class="text-3xl font-bold mb-2 text-main">Configuration</h2>
                    <p class="text-accent mb-6">Define the parameters for the Blockchain Interaction, including network settings, amounts, delays, and gas thresholds.</p>

                    <!-- NEW: API Key Input -->
                    <div class="mb-6">
                        <label for="api-key-input" class="block font-medium text-accent mb-1">Gemini API Key (Optional)</label>
                        <input type="text" id="api-key-input" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Enter your Gemini API Key (e.g., AIzaSy...)">
                        <p class="text-sm text-gray-500 mt-1">If left blank, a default key may be used (if available in environment).</p>
                    </div>

                    <!-- NEW: Stealth Profile Preset -->
                    <div class="mb-6">
                        <label for="stealth-profile" class="block font-medium text-accent mb-1">Stealth Profile Preset</label>
                        <select id="stealth-profile" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <option value="balanced" selected>üß† Balanced (Default)</option>
                            <option value="aggressive">üöÄ Aggressive Interaction</option>
                            <option value="ultraSlow">üê¢ Ultra-Slow & Stealthy</option>
                            <option value="custom">‚öôÔ∏è Manual Custom</option>
                        </select>
                    </div>

                    <!-- Main configuration grid container -->
                    <div class="bg-secondary p-8 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Individual configuration items -->
                        <div>
                            <label for="max-txns-per-wallet" class="block font-medium mb-1 text-accent">Max Actions Per Wallet Session
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">The maximum number of distinct actions (send, idle, balance check) a single wallet will attempt in its session on a given blockchain network. The actual number of actions will be randomized up to this maximum.</span></span>
                            </label>
                            <input type="number" id="max-txns-per-wallet" value="3" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Maximum actions a single wallet will perform in its session on a given chain.</p>
                        </div>
                        <div>
                            <label for="wallet-idle-chance" class="block font-medium mb-1 text-accent">Wallet Idle Chance (%)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">The percentage chance that a specific wallet will be "idle" for an entire session on a chain, meaning it will perform no actions. This simulates unpredictable human-like behavior.</span></span>
                            </label>
                            <input type="number" id="wallet-idle-chance" value="25" min="0" max="100" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Chance for a wallet to be idle and skip its session on a chain.</p>
                        </div>
                        <div>
                            <label for="gas-multiplier" class="block font-medium mb-1 text-accent">Max Gas Price Multiplier
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">If the current gas price on the network exceeds the average gas price by this multiplier, the script will temporarily pause activities for that wallet on that chain to avoid high fees.</span></span>
                            </label>
                            <input type="number" id="gas-multiplier" value="2" step="0.1" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Skip wallet activity if current gas price exceeds average by this multiplier.</p>
                        </div>
                        <!-- NEW: Min Gas Factor -->
                        <div>
                            <label for="min-gas-factor" class="block font-medium mb-1 text-accent">Min Gas Factor (x)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">A random factor (between this min and Max Gas Factor) will be applied to the calculated gas price/priority fee to introduce variance.</span></span>
                            </label>
                            <input type="number" id="min-gas-factor" value="0.9" step="0.01" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Minimum factor for random gas price/priority fee adjustment.</p>
                        </div>
                        <!-- NEW: Max Gas Factor -->
                        <div>
                            <label for="max-gas-factor" class="block font-medium mb-1 text-accent">Max Gas Factor (x)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">A random factor (between Min Gas Factor and this max) will be applied to the calculated gas price/priority fee to introduce variance.</span></span>
                            </label>
                            <input type="number" id="max-gas-factor" value="1.1" step="0.01" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Maximum factor for random gas price/priority fee adjustment.</p>
                        </div>
                        <div>
                            <label for="block-lookback" class="block font-medium mb-1 text-accent">Blocks to Scan for Addresses
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">The number of recent blockchain blocks the script will scan to find and add new potential recipient addresses to its pool. A higher number means more discovery but takes longer.</span></span>
                            </label>
                            <input type="number" id="block-lookback" value="100" min="10" max="1000" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Number of recent blocks to scan for new recipient addresses.</p>
                        </div>

                        <!-- NEW: Probability Jitter Factor -->
                        <div>
                            <label for="prob-jitter-factor" class="block font-medium mb-1 text-accent">Probability Jitter Factor (%)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">A percentage range (e.g., 5 for ¬±5%) within which each wallet's action probabilities (Send, Idle, Balance Check) will randomly vary from the global configured probabilities. Set to 0 for no jitter.</span></span>
                            </label>
                            <input type="number" id="prob-jitter-factor" value="5" min="0" max="50" step="1" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Random variation applied to each wallet's action probabilities.</p>
                        </div>
                        <!-- NEW: Simulated Error Chance -->
                        <div>
                            <label for="simulated-error-chance" class="block font-medium mb-1 text-accent">Simulated Transaction Error Chance (%)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">The percentage chance that a 'send' transaction will randomly fail, mimicking network errors. The script will then retry with exponential backoff. Set to 0 to disable.</span></span>
                            </label>
                            <input type="number" id="simulated-error-chance" value="0" min="0" max="100" step="1" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Chance for a transaction to randomly fail (simulated).</p>
                        </div>

                        <!-- NEW: Think Time Bursts -->
                        <div>
                            <label for="think-time-chance" class="block font-medium mb-1 text-accent">Think Time Chance (%)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">The percentage chance that a wallet will enter a longer "think time" pause (1-2 minutes) between actions, simulating human cognitive breaks.</span></span>
                            </label>
                            <input type="number" id="think-time-chance" value="10" min="0" max="100" step="1" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Chance for a longer "think time" delay.</p>
                        </div>
                        <div>
                            <label for="min-think-time" class="block font-medium mb-1 text-accent">Min Think Time (seconds)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">Minimum duration for a "think time" pause.</span></span>
                            </label>
                            <input type="number" id="min-think-time" value="60" min="10" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Minimum seconds for a "think time" pause.</p>
                        </div>
                        <div>
                            <label for="max-think-time" class="block font-medium mb-1 text-accent">Max Think Time (seconds)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">Maximum duration for a "think time" pause.</span></span>
                            </label>
                            <input type="number" id="max-think-time" value="120" min="10" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Maximum seconds for a "think time" pause.</p>
                        </div>

                        <!-- NEW: Activity Bursts & Lulls -->
                        <div>
                            <label for="activity-burst-chance" class="block font-medium mb-1 text-accent">Activity Burst Chance (%)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">The percentage chance that a wallet will enter an "activity burst" session, performing multiple actions in quick succession before a longer lull.</span></span>
                            </label>
                            <input type="number" id="activity-burst-chance" value="50" min="0" max="100" step="1" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Chance for a wallet to perform actions in a burst.</p>
                        </div>
                        <div>
                            <label for="min-burst-actions" class="block font-medium mb-1 text-accent">Min Burst Actions
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">Minimum number of actions to perform during an activity burst.</span></span>
                            </label>
                            <input type="number" id="min-burst-actions" value="2" min="1" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Minimum actions in a burst.</p>
                        </div>
                        <div>
                            <label for="max-burst-actions" class="block font-medium mb-1 text-accent">Max Burst Actions
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">Maximum number of actions to perform during an activity burst.</span></span>
                            </label>
                            <input type="number" id="max-burst-actions" value="5" min="1" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Maximum actions in a burst.</p>
                        </div>
                        <div>
                            <label for="min-lull-time" class="block font-medium mb-1 text-accent">Min Lull Time (seconds)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">Minimum duration for a "lull" period after an activity burst.</span></span>
                            </label>
                            <input type="number" id="min-lull-time" value="300" min="60" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Minimum seconds for a lull period.</p>
                        </div>
                        <div>
                            <label for="max-lull-time" class="block font-medium mb-1 text-accent">Max Lull Time (seconds)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">Maximum duration for a "lull" period after an activity burst.</span></span>
                            </label>
                            <input type="number" id="max-lull-time" value="900" min="60" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Maximum seconds for a lull period.</p>
                        </div>

                        <!-- NEW: Time-of-Day Bias -->
                        <div class="md:col-span-2">
                            <label class="flex items-center mb-1 text-accent">
                                <input type="checkbox" id="enable-time-of-day-bias" class="form-checkbox h-5 w-5 text-blue-600 wallet-feature-control" disabled>
                                <span class="ml-3 text-main">Enable Time-of-Day Bias
                                    <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">Adjusts activity rates to mimic human awake hours (e.g., lower activity during local night).</span></span>
                                </span>
                            </label>
                            <p class="text-sm text-gray-500 mt-1">If enabled, activity will be reduced during simulated night hours (1 AM - 6 AM local time).</p>
                        </div>

                        <!-- NEW: RPC Switch Delay -->
                        <div>
                            <label for="rpc-switch-delay" class="block font-medium mb-1 text-accent">RPC Switch Delay (seconds)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">Delay introduced when switching between different RPC endpoints to simulate network imperfection.</span></span>
                            </label>
                            <input type="number" id="rpc-switch-delay" value="5" min="0" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Delay when switching RPC endpoints.</p>
                        </div>

                        <!-- NEW: Wallet Switch Delay -->
                        <div>
                            <label for="wallet-switch-delay" class="block font-medium mb-1 text-accent">Wallet Switch Delay (seconds)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">Delay introduced when switching between different wallets to simulate human-like pauses.</span></span>
                            </label>
                            <input type="number" id="wallet-switch-delay" value="5" min="2" max="8" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            <p class="text-sm text-gray-500 mt-1">Delay when switching between wallets (2-8 seconds).</p>
                        </div>


                        <!-- Transaction Amount Range (spans 2 columns on medium screens and up) -->
                        <div class="md:col-span-2">
                            <label class="block font-medium mb-1 text-accent">Transaction Amount Range (ETH)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">When a 'send' action is chosen, a random amount of ETH will be sent within this specified minimum and maximum range.</span></span>
                            </label>
                            <div class="flex items-center space-x-4">
                                <!-- Using flex-1 to ensure inputs share space equally within the flex container -->
                                <input type="number" id="min-amount" value="0.0001" step="0.0001" class="flex-1 p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                                <span class="text-gray-500">to</span>
                                <input type="number" id="max-amount" value="0.0002" step="0.0001" class="flex-1 p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            </div>
                             <p class="text-sm text-gray-500 mt-1">A random ETH amount within this range will be sent for 'send' actions.</p>
                             <button id="explain-send-tx-btn" class="mt-4 py-2 px-4 rounded-lg font-semibold transition-all duration-300 btn-llm wallet-feature-control" disabled>‚ú® Explain Send Tx</button>
                        </div>

                        <!-- Delay Between Actions (spans 2 columns on medium screens and up) -->
                        <div class="md:col-span-2">
                            <label class="block font-medium mb-1 text-accent">Delay Between Actions (seconds)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">After each action (send, idle, balance check), the script will pause for a random duration, sampled from a log-normal distribution, within this minimum and maximum second range.</span></span>
                            </label>
                            <div class="flex items-center space-x-4">
                                <!-- Using flex-1 to ensure inputs share space equally within the flex container -->
                                <input type="number" id="min-delay" value="10" class="flex-1 p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                                <span class="text-gray-500">to</span>
                                <input type="number" id="max-delay" value="30" class="flex-1 p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">A log-normal random delay will be applied after each action.</p>
                        </div>

                        <!-- RPC Endpoints & Chain IDs (spans 2 columns on medium screens and up) -->
                        <div class="md:col-span-2">
                            <label class="block font-medium mb-1 text-accent">RPC Endpoints & Chain IDs (Format: URL,ChainID - one per line)
                                <span class="tooltip-container ml-1 text-gray-400 cursor-pointer">‚ÑπÔ∏è<span class="tooltip-text">List the RPC URLs for the blockchain networks you want to interact with, followed by their corresponding Chain ID (e.g., 'https://mainnet.infura.io/v3/YOUR_ID,1'). The script will cycle through these networks.</span></span>
                            </label>
                            <textarea id="rpc-urls" rows="4" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition wallet-feature-control" disabled>https://mainnet.infura.io/v3/YOUR_PROJECT_ID,1
https://rpc.goerli.dev,5</textarea>
                            <p class="text-sm text-gray-500 mt-1">The script will cycle through these RPCs and chains.</p>
                            <button id="test-rpc-btn" class="mt-4 py-2 px-4 rounded-lg font-semibold transition-all duration-300 btn-secondary wallet-feature-control" disabled>‚ö° Test RPC Connections</button>
                        </div>

                        <!-- Action Probability Matrix (spans 2 columns on medium screens and up, contains its own grid) -->
                        <div class="md:col-span-2">
                            <h3 class="font-bold text-lg mb-4 text-main">Action Probability Matrix (%)</h3>
                            <p class="text-sm text-accent mb-4">Define the percentage chance for each action type. Must sum to 100.</p>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                <div>
                                    <label for="prob-send" class="block font-medium mb-1 text-accent">Send</label>
                                    <input type="number" id="prob-send" value="40" min="0" max="100" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition prob-input wallet-feature-control" disabled>
                                </div>
                                <div>
                                    <label for="prob-deploy" class="block font-medium mb-1 text-accent">Deploy Contract</label>
                                    <input type="number" id="prob-deploy" value="20" min="0" max="100" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition prob-input wallet-feature-control" disabled>
                                </div>
                                <div>
                                    <label for="prob-interact" class="block font-medium mb-1 text-accent">Interact Contract</label>
                                    <input type="number" id="prob-interact" value="20" min="0" max="100" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition prob-input wallet-feature-control" disabled>
                                </div>
                                <div>
                                    <label for="prob-idle-action" class="block font-medium mb-1 text-accent">Idle Action</label>
                                    <input type="number" id="prob-idle-action" value="10" min="0" max="100" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition prob-input wallet-feature-control" disabled>
                                </div>
                                <div>
                                    <label for="prob-balance-check" class="block font-medium mb-1 text-accent">Balance Check</label>
                                    <input type="number" id="prob-balance-check" value="10" min="0" max="100" class="w-full p-2 border border-accent rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition prob-input wallet-feature-control" disabled>
                                </div>
                            </div>
                            <p id="prob-sum-warning" class="text-sm text-red-500 mt-2 hidden">Probabilities must sum to 100%!</p>
                        </div>
                    </div>
                </section>


                <!-- Live Log Section -->
                <section id="log">
                     <h2 class="text-3xl font-bold mb-2 text-main">Live Log</h2>
                     <p class="text-accent mb-6">Real-time output from the Blockchain Interaction process will appear below. You can also download the complete log.</p>
                    <div class="bg-gray-800 text-white rounded-lg shadow-md p-4 h-96 overflow-y-auto mb-4">
                        <div id="live-log"></div>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <div class="dropdown">
                            <button id="download-log-btn" class="py-2 px-4 rounded-lg font-semibold transition-all duration-300 btn-success wallet-feature-control" disabled>‚¨áÔ∏è Download Log</button>
                            <div class="dropdown-content">
                                <button id="download-log-csv-btn">Download CSV</button>
                                <button id="download-log-json-btn">Download JSON</button>
                            </div>
                        </div>
                        <button id="clear-log-btn" class="py-2 px-4 rounded-lg font-semibold transition-all duration-300 btn-secondary wallet-feature-control" disabled>üóëÔ∏è Clear Log</button>
                        <button id="summarize-log-btn" class="py-2 px-4 rounded-lg font-semibold transition-all duration-300 btn-llm wallet-feature-control" disabled>‚ú® Summarize Log</button>
                    </div>
                </section>
            </div><!-- End script-console-content -->
        </div><!-- End container mx-auto -->
    </main>

    <!-- UPDATED FOOTER SECTION -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-6 text-center">
            <h3 class="text-2xl font-bold mb-2">We Grow Together!</h3>
            <p class="mb-4 max-w-2xl mx-auto text-gray-300">
                Your contributions help keep this project alive, ad-free, and continuously improving. Consider supporting our development efforts by donating.
            </p>
            <div class="flex items-center justify-center bg-gray-700 p-3 rounded-lg max-w-md mx-auto mb-6 shadow-md">
                <span id="donation-address" class="text-sm md:text-base text-white font-mono break-all mr-2">0x1C46ccEA4D62d3eEC4DCE3501aa96d0Ff5FcA954</span>
                <button id="copy-address-btn" class="ml-auto p-2 rounded-md hover:bg-gray-600 transition-colors" title="Copy Address">
                    <svg id="copy-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                        <path d="M4 1.5H3a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-8a1 1 0 0 1 1-1h1v-1z"/>
                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                    </svg>
                     <svg id="check-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check2 hidden text-green-400" viewBox="0 0 16 16">
                        <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                    </svg>
                </button>
                <button id="show-qr-btn" class="ml-2 p-2 rounded-md hover:bg-gray-600 transition-colors" title="Show QR Code">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-qr-code" viewBox="0 0 16 16">
                        <path d="M2 2h2v2H2V2Z"/>
                        <path d="M6 0v6H0V0h6ZM5 1H1v4h4V1ZM4 12H2v2h2v-2Z"/>
                        <path d="M6 10v6H0v-6h6Zm-5 1v4h4v-4H1Zm11-9h2v2h-2V2Z"/>
                        <path d="M10 0v6h6V0h-6ZM5 1v4h-4V1h4ZM8 1V0h1v2H8v2H7V1h1Zm0 5V4h1v2H8ZM6 8V7h1V6h1v2h1V7h5v1h-4v1H7V8H6Zm0 0v1H2V8H1v1H0V7h3v1h3Zm10 1h-1V7h1v2Zm-1 0h-1v2h2v-1h-1V9Zm-4 0h2v1h-1v1h-1V9Zm2 3v-1h-1v1h-1v1H9v1h3v-2h1v-1h-3Zm-4-3v1h1v-2H7v1h2v1H7Z"/>
                        <path d="M7 12h1v3h4v1H7v-4Zm9 2v2h-3v-1h2v-1h1Z"/>
                    </svg>
                </button>
            </div>
             <p class="text-sm text-gray-400 mt-8">
                &copy; 2025 FarmLabs. All rights reserved.
            </p>
            <div class="flex items-center justify-center mt-4 space-x-6">
                <a href="https://farm-labs.blogspot.com/" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white" title="Blog">
                    <i class="fab fa-blogger fa-lg"></i>
                </a>
                <a href="https://t.me/farm_lab" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white" title="Telegram">
                    <i class="fab fa-telegram fa-lg"></i>
                </a>
                <a href="https://github.com/CryptoExplor/farmlabs" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white" title="GitHub">
                    <i class="fab fa-github fa-lg"></i>
                </a>
            </div>
        </div>
    </footer>

    <!-- QR Code Modal -->
    <div id="qr-code-modal" class="modal hidden">
        <div class="modal-content text-main flex flex-col items-center text-center">
            <span class="close-qr-button self-end">&times;</span>
            <h3 class="text-xl font-bold mb-4">Donation Address</h3>
            <div id="qr-code-container" class="p-4 bg-white inline-block rounded-lg shadow-inner"></div>
            <p class="font-mono text-xs mt-4 break-all" id="qr-address-display"></p>
        </div>
    </div>
    
    <!-- Gemini Explanation Modal -->
    <div id="gemini-modal" class="modal hidden">
        <div class="modal-content text-main">
            <span class="close-button">&times;</span>
            <h3 id="modal-title" class="text-xl font-bold mb-4">Gemini Explanation</h3>
            <div id="modal-content" class="text-accent">
                <div class="modal-loader"></div>
                <p class="text-center mt-4">Generating explanation...</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal hidden">
        <div class="modal-content text-main">
            <span class="close-confirm-button">&times;</span>
            <h3 class="text-xl font-bold mb-4">Confirm Action</h3>
            <p id="confirm-message" class="mb-6 text-accent">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-confirm-btn" class="py-2 px-4 rounded-lg font-semibold btn-secondary">Cancel</button>
                <button id="confirm-action-btn" class="py-2 px-4 rounded-lg font-semibold btn-primary">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Utility for random number generation (used in Stealth.js)
        const Stealth = {
            // Generates a random number within a specified range (min inclusive, max exclusive)
            getRandomInRange: (min, max) => Math.random() * (max - min) + min,

            // Generates a random delay using a log-normal distribution
            // min and max are in milliseconds
            generateLogNormalDelay: (min, max) => {
                const mu = Math.log(min);
                const sigma = (Math.log(max) - Math.log(min)) / 4; // Adjust sigma for desired spread
                let u1 = Math.random();
                let u2 = Math.random();
                // Box-Muller transform to get a standard normal deviate
                let z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
                // Scale and shift to log-normal distribution
                return Math.exp(mu + sigma * z0);
            }
        };

        // --- Contract Memory Management ---
        const CONTRACT_STORAGE_KEY = "walletChainContractsV2";
        // Initialize from localStorage, or an empty object if nothing is stored
        let walletChainContracts = JSON.parse(localStorage.getItem(CONTRACT_STORAGE_KEY) || "{}");

        // Placeholder bytecodes for simplicity. In a real scenario, these would be full compiled bytecodes.
        // For demonstration, these are minimal valid bytecodes for simple contracts.
        // Storage Contract: Stores and retrieves a uint256.
        const STORAGE_BYTECODE = "0x6080604052348015610010575f80fd5b5060043610610036575f3560e01c80632a1afcd91461003b57806360fe47b114610057575f80fd5b61004361006f565b60405161005091906100a3565b60405180910390f35b61006d600480360381019061006891906100e4565b610074565b005b5f8054905090565b5f819050919050565b61009181610082565b82525050565b5f6020820190506100ab5f83018461007d565b92915050565b5f6020820190506100c55f83018461007d565b92915050565b6000602082019050818103818337808201805160008190506000928190602082018282806000818480808080600073ffffffffffffffffffffffffffffffffffffffff16fffe";
        // Counter Contract: Increments and retrieves a counter.
        const COUNTER_BYTECODE = "0x6080604052348015610010575f80fd5b5060043610610036575f3560e01c806360fe47b1461003b5780638381f58214610057575f80fd5b610043610073565b60405161005091906100a7565b60405180910390f35b61005f610078565b6040518082815260200191505060405180910390f35b5f8054905090565b5f819050919050565b61009081610082565b82525050565b5f60208201905061009f5f83018461007c565b92915050565b5f6020820190506100b95f83018461007c565b92915050565b6000602082019050818103818337808201805160008190506000928190602082018282806000818480808080600073ffffffffffffffffffffffffffffffffffffffff16fffe";
        // Dummy Contract: Has two simple functions, ping and pong.
        const DUMMY_BYTECODE = "0x6080604052348015610010575f80fd5b5060043610610036575f3560e01c80633734c58a1461003b5780633f2a368b14610057575f80fd5b610043610073565b60405161005091906100a7565b60405180910390f35b61005f610078565b6040518082815260200191505060405180910390f35b5f8054905090565b5f819050919050565b61009081610082565b82525050565b5f60208201905061009f5f83018461007c565b92915050565b5f6020820190506100b95f83018461007c565b92915050565b6000602082019050818103818337808201805160008190506000928190602082018282806000818480808080600073ffffffffffffffffffffffffffffffffffffffff16fffe";

        const contracts = {
            storage: {
                name: "Storage",
                abi: ["function store(uint256)", "function retrieve() view returns (uint256)"],
                bytecode: STORAGE_BYTECODE
            },
            counter: {
                name: "Counter",
                abi: ["function increment()", "function get() view returns (uint256)"],
                bytecode: COUNTER_BYTECODE
            },
            dummy: {
                name: "Dummy",
                abi: ["function ping() public", "function pong() public"],
                bytecode: DUMMY_BYTECODE
            }
        };

        /**
         * Saves a deployed contract's information to local storage.
         * @param {string} walletAddress - The address of the wallet that deployed the contract.
         * @param {string} chainId - The chain ID where the contract was deployed.
         * @param {string} address - The address of the deployed contract.
         * @param {string} type - The type/name of the contract (e.g., "Storage", "Counter").
         */
        function saveContract(walletAddress, chainId, address, type) {
            if (!walletChainContracts[walletAddress]) walletChainContracts[walletAddress] = {};
            if (!walletChainContracts[walletAddress][chainId]) walletChainContracts[walletAddress][chainId] = [];
            // Check if contract already exists to prevent duplicates
            const exists = walletChainContracts[walletAddress][chainId].some(c => c.address.toLowerCase() === address.toLowerCase());
            if (!exists) {
                walletChainContracts[walletAddress][chainId].push({ address, type });
                localStorage.setItem(CONTRACT_STORAGE_KEY, JSON.stringify(walletChainContracts));
                log(`Contract ${type} at ${address.slice(0,6)}...${address.slice(-4)} saved for wallet ${walletAddress.slice(0,6)}...${walletAddress.slice(-4)} on chain ${chainId}.`, 'info');
            }
        }

        /**
         * Retrieves deployed contracts for a specific wallet and chain.
         * @param {string} walletAddress - The wallet address.
         * @param {string} chainId - The chain ID.
         * @returns {Array<Object>} An array of contract objects ({ address, type }).
         */
        function getContractsByChain(walletAddress, chainId) {
            return (walletChainContracts[walletAddress] && walletChainContracts[walletAddress][chainId]) || [];
        }

        /**
         * Retrieves all deployed contracts across all wallets for a specific chain.
         * @param {string} chainId - The chain ID.
         * @returns {Array<Object>} An array of all contract objects ({ address, type }) on that chain.
         */
        function getAllContractsByChain(chainId) {
            const results = [];
            for (const wallet in walletChainContracts) {
                if (walletChainContracts[wallet][chainId]) {
                    results.push(...walletChainContracts[wallet][chainId]);
                }
            }
            return results;
        }

        /**
         * Picks a random element from an array.
         * @param {Array} arr - The array to pick from.
         * @returns {*} A random element from the array.
         */
        function pickRandom(arr) {
            if (!arr || arr.length === 0) return null;
            return arr[Math.floor(Math.random() * arr.length)];
        }

        /**
         * Deploys a random contract from the predefined list.
         * @param {ethers.Wallet} wallet - The ethers.js Wallet instance.
         * @param {ethers.JsonRpcProvider} provider - The ethers.js JsonRpcProvider instance.
         * @param {string} chainId - The chain ID where the contract will be deployed.
         * @returns {Promise<Object|null>} An object containing the deployed contract's address and type, or null if deployment fails.
         */
        async function deployRandomContract(wallet, provider, chainId) {
            const typeKeys = Object.keys(contracts);
            if (typeKeys.length === 0) {
                log('No contract types defined for deployment.', 'error');
                return null;
            }
            const typeKey = pickRandom(typeKeys);
            const contractMeta = contracts[typeKey];

            try {
                const factory = new ethers.ContractFactory(contractMeta.abi, contractMeta.bytecode, wallet);
                const contract = await factory.deploy();
                await contract.waitForDeployment();
                const address = await contract.getAddress();
                log(`üì¶ Deployed [${contractMeta.name}] at ${address.slice(0,6)}...${address.slice(-4)}`, "log-success");
                saveContract(wallet.address, chainId, address, contractMeta.name);
                return { address, type: contractMeta.name };
            } catch (e) {
                log(`‚ùå Failed to deploy [${contractMeta.name}]: ${e.message}`, "log-error");
                return null;
            }
        }

        /**
         * Interacts with a given deployed contract based on its type.
         * @param {ethers.Wallet} wallet - The ethers.js Wallet instance.
         * @param {Object} contractData - An object containing the contract's address and type ({ address, type }).
         * @returns {Promise<void>}
         */
        async function interactContract(wallet, contractData) {
            const { address, type } = contractData;
            const contractMeta = Object.values(contracts).find(c => c.name === type);
            if (!contractMeta) {
                log(`‚ùå Unknown contract type: ${type} for address ${address.slice(0,6)}...${address.slice(-4)}`, "log-error");
                return;
            }
            const contract = new ethers.Contract(address, contractMeta.abi, wallet);
            try {
                if (type === "Storage") {
                    const val = Math.floor(Stealth.getRandomInRange(1, 1000));
                    log(`[Storage] Calling store(${val}) on ${address.slice(0,6)}...${address.slice(-4)}...`, 'info');
                    const tx = await contract.store(val);
                    await tx.wait();
                    const result = await contract.retrieve();
                    log(`üì• [Storage] ${address.slice(0,6)}...${address.slice(-4)}: Stored ${val} => Retrieved ${result}`, "log-info");
                } else if (type === "Counter") {
                    log(`[Counter] Calling increment() on ${address.slice(0,6)}...${address.slice(-4)}...`, 'info');
                    const tx = await contract.increment();
                    await tx.wait();
                    const count = await contract.get();
                    log(`üî¢ [Counter] ${address.slice(0,6)}...${address.slice(-4)}: Count = ${count}`, "log-info");
                } else if (type === "Dummy") {
                    log(`[Dummy] Calling ping() and pong() on ${address.slice(0,6)}...${address.slice(-4)}...`, 'info');
                    const pingTx = await contract.ping();
                    await pingTx.wait();
                    const pongTx = await contract.pong();
                    await pongTx.wait();
                    log(`üéØ [Dummy] ${address.slice(0,6)}...${address.slice(-4)} ping-pong success`, "log-info");
                }
            } catch (e) {
                log(`‚ùå Interaction with [${type}] at ${address.slice(0,6)}...${address.slice(-4)} failed: ${e.message}`, "log-error");
            }
        }

        // --- Stealth Config Auto-Injector ---
        // Helper to set values by ID
        const setConfigValue = (id, value) => {
            const el = document.getElementById(id);
            if (!el) return;
            if (el.type === "checkbox") el.checked = value;
            else if (el.tagName === "TEXTAREA") el.value = value.join('\n');
            else el.value = value;
        };

        const injectStealthDefaults = () => {
            const stealthDefaults = {
                "max-txns-per-wallet": 5,
                "wallet-idle-chance": 30,
                "block-lookback": 200,
                "simulated-error-chance": 3,
                "enable-time-of-day-bias": true,
                "prob-send": 40, // Updated default
                "prob-deploy": 20, // NEW default
                "prob-interact": 20, // NEW default
                "prob-idle-action": 10, // Updated default
                "prob-balance-check": 10, // Updated default
                "min-amount": 0.0000001,
                "max-amount": 0.0002,
                "min-delay": 10,
                "max-delay": 30,
                "min-gas-factor": 0.9,
                "max-gas-factor": 1.5,
                "gas-multiplier": 2,
                "prob-jitter-factor": 5,
                "think-time-chance": 10,
                "min-think-time": 60,
                "max-think-time": 120,
                "activity-burst-chance": 50,
                "min-burst-actions": 2,
                "max-burst-actions": 5,
                "min-lull-time": 300,
                "max-lull-time": 900,
                "rpc-switch-delay": 5,
                "wallet-switch-delay": 5, // NEW: walletSwitchDelay default
                "rpc-urls": [
                    "https://mainnet.infura.io/v3/YOUR_PROJECT_ID,1",
                    "https://rpc.goerli.dev,5"
                ]
            };

            setConfigValue("max-txns-per-wallet", stealthDefaults["max-txns-per-wallet"]);
            setConfigValue("wallet-idle-chance", stealthDefaults["wallet-idle-chance"]);
            setConfigValue("block-lookback", stealthDefaults["block-lookback"]);
            setConfigValue("simulated-error-chance", stealthDefaults["simulated-error-chance"]);
            setConfigValue("enable-time-of-day-bias", stealthDefaults["enable-time-of-day-bias"]);
            setConfigValue("prob-send", stealthDefaults["prob-send"]);
            setConfigValue("prob-deploy", stealthDefaults["prob-deploy"]); // NEW
            setConfigValue("prob-interact", stealthDefaults["prob-interact"]); // NEW
            setConfigValue("prob-idle-action", stealthDefaults["prob-idle-action"]);
            setConfigValue("prob-balance-check", stealthDefaults["prob-balance-check"]);
            setConfigValue("min-amount", stealthDefaults["min-amount"]);
            setConfigValue("max-amount", stealthDefaults["max-amount"]);
            setConfigValue("min-delay", stealthDefaults["min-delay"]);
            setConfigValue("max-delay", stealthDefaults["max-delay"]);
            setConfigValue("min-gas-factor", stealthDefaults["min-gas-factor"]);
            setConfigValue("max-gas-factor", stealthDefaults["max-gas-factor"]);
            setConfigValue("gas-multiplier", stealthDefaults["gas-multiplier"]);
            setConfigValue("prob-jitter-factor", stealthDefaults["prob-jitter-factor"]);
            setConfigValue("think-time-chance", stealthDefaults["think-time-chance"]);
            setConfigValue("min-think-time", stealthDefaults["min-think-time"]);
            setConfigValue("max-think-time", stealthDefaults["max-think-time"]);
            setConfigValue("activity-burst-chance", stealthDefaults["activity-burst-chance"]);
            setConfigValue("min-burst-actions", stealthDefaults["min-burst-actions"]);
            setConfigValue("max-burst-actions", stealthDefaults["max-burst-actions"]);
            setConfigValue("min-lull-time", stealthDefaults["min-lull-time"]);
            setConfigValue("max-lull-time", stealthDefaults["max-lull-time"]);
            setConfigValue("rpc-switch-delay", stealthDefaults["rpc-switch-delay"]);
            setConfigValue("wallet-switch-delay", stealthDefaults["wallet-switch-delay"]); // NEW: walletSwitchDelay
            setConfigValue("rpc-urls", stealthDefaults["rpc-urls"]);
        };

        // --- Stealth Profile Selector ---
        const stealthProfiles = {
            balanced: {
                "max-txns-per-wallet": 5,
                "wallet-idle-chance": 30,
                "block-lookback": 300,
                "simulated-error-chance": 2,
                "enable-time-of-day-bias": true,
                "prob-send": 40,
                "prob-deploy": 20,
                "prob-interact": 20,
                "prob-idle-action": 10,
                "prob-balance-check": 10,
                "min-amount": 0.0001,
                "max-amount": 0.0002,
                "min-delay": 10,
                "max-delay": 30,
                "min-gas-factor": 0.9,
                "max-gas-factor": 1.1,
                "gas-multiplier": 2,
                "prob-jitter-factor": 5,
                "think-time-chance": 10,
                "min-think-time": 60,
                "max-think-time": 120,
                "activity-burst-chance": 50,
                "min-burst-actions": 2,
                "max-burst-actions": 5,
                "min-lull-time": 300,
                "max-lull-time": 900,
                "rpc-switch-delay": 5,
                "wallet-switch-delay": 5, // NEW: walletSwitchDelay
                "rpc-urls": [
                    "https://mainnet.infura.io/v3/YOUR_PROJECT_ID,1",
                    "https://rpc.goerli.dev,5"
                ]
            },
            aggressive: {
                "max-txns-per-wallet": 8,
                "wallet-idle-chance": 10,
                "block-lookback": 100,
                "simulated-error-chance": 1,
                "enable-time-of-day-bias": false,
                "prob-send": 50,
                "prob-deploy": 25,
                "prob-interact": 15,
                "prob-idle-action": 5,
                "prob-balance-check": 5,
                "min-amount": 0.0002,
                "max-amount": 0.0004,
                "min-delay": 5,
                "max-delay": 15,
                "min-gas-factor": 1.0,
                "max-gas-factor": 1.3,
                "gas-multiplier": 3,
                "prob-jitter-factor": 2,
                "think-time-chance": 2,
                "min-think-time": 10,
                "max-think-time": 20,
                "activity-burst-chance": 80,
                "min-burst-actions": 3,
                "max-burst-actions": 8,
                "min-lull-time": 60,
                "max-lull-time": 180,
                "rpc-switch-delay": 2,
                "wallet-switch-delay": 2, // NEW: walletSwitchDelay
                "rpc-urls": [
                    "https://rpc.ankr.com/eth,1",
                    "https://rpc.ankr.com/eth_goerli,5"
                ]
            },
            ultraSlow: {
                "max-txns-per-wallet": 2,
                "wallet-idle-chance": 50,
                "block-lookback": 500,
                "simulated-error-chance": 5,
                "enable-time-of-day-bias": true,
                "prob-send": 20,
                "prob-deploy": 10,
                "prob-interact": 10,
                "prob-idle-action": 30,
                "prob-balance-check": 30,
                "min-amount": 0.00005,
                "max-amount": 0.0001,
                "min-delay": 20,
                "max-delay": 90,
                "min-gas-factor": 0.8,
                "max-gas-factor": 1.0,
                "gas-multiplier": 1.5,
                "prob-jitter-factor": 8,
                "think-time-chance": 25,
                "min-think-time": 90,
                "max-think-time": 180,
                "activity-burst-chance": 20,
                "min-burst-actions": 1,
                "max-burst-actions": 3,
                "min-lull-time": 900,
                "max-lull-time": 1800,
                "rpc-switch-delay": 8,
                "wallet-switch-delay": 8, // NEW: walletSwitchDelay
                "rpc-urls": [
                    "https://rpc.ankr.com/eth_sepolia,11155111"
                ]
            }
        };

        const applyProfile = (profileName) => {
            const profile = stealthProfiles[profileName];
            if (!profile) return;
            Object.entries(profile).forEach(([id, value]) => {
                // Convert id from kebab-case to camelCase for direct mapping to HTML element IDs
                const elementId = id.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
                setConfigValue(elementId, value);
            });
            // After applying a profile, re-load the configuration to update appState
            loadConfiguration();
        };


        document.addEventListener('DOMContentLoaded', () => {
            const appState = {
                isRunning: false,
                stopFlag: false,
                wallets: [],
                rpcConfigs: [], // [{url, chainId}]
                currentRecipientPool: {}, // {chainId: [addresses]}
                manualRecipientList: [], // For user-provided list
                predefinedRecipientList: [], // Now loaded from CSV
                config: {},
                stats: {
                    totalActions: 0,
                    successfulActions: 0,
                    failedActions: 0,
                    // Updated actionCounts to include 'deploy' and 'interact'
                    actionCounts: { send: 0, deploy: 0, interact: 0, idle: 0, 'balance-check': 0, skipped: 0 }
                },
                logEntries: [], // For CSV export
                charts: {
                    walletBalance: null, // Console's wallet balance chart
                    actionDist: null,    // Console's action distribution chart
                },
                pendingConfirmation: null, // Callback for confirmation modal
                connectedAddress: null,
                lastHumanLikeSpike: null, // To track the last "human-like" spike
            };

            // Inject default stealth config values on load
            injectStealthDefaults();

            // UI elements for sidebar
            const sidebar = document.getElementById('sidebar');

            const ui = {
                connectWalletBtn: document.getElementById('connect-wallet-btn'),
                walletStatusDisplay: document.getElementById('wallet-status-display'),
                // IMPORTANT: Exclude connectWalletBtn from walletFeatureControls
                walletFeatureControls: document.querySelectorAll('.wallet-feature-control'),
                startBtn: document.getElementById('start-btn'),
                stopBtn: document.getElementById('stop-btn'),
                clearAllDataBtn: document.getElementById('clear-all-data-btn'),
                exportContractMemoryBtn: document.getElementById('export-contract-memory-btn'), // NEW
                importContractMemoryBtn: document.getElementById('import-contract-memory-btn'), // NEW
                importContractMemoryInput: document.getElementById('import-contract-memory-input'), // NEW
                maxTxnsPerWallet: document.getElementById('max-txns-per-wallet'),
                walletIdleChance: document.getElementById('wallet-idle-chance'),
                minAmount: document.getElementById('min-amount'),
                maxAmount: document.getElementById('max-amount'),
                minDelay: document.getElementById('min-delay'),
                maxDelay: document.getElementById('max-delay'),
                gasMultiplier: document.getElementById('gas-multiplier'),
                minGasFactor: document.getElementById('min-gas-factor'),
                maxGasFactor: document.getElementById('max-gas-factor'),
                blockLookback: document.getElementById('block-lookback'),
                probJitterFactor: document.getElementById('prob-jitter-factor'), // NEW
                simulatedErrorChance: document.getElementById('simulated-error-chance'), // NEW
                thinkTimeChance: document.getElementById('think-time-chance'), // NEW
                minThinkTime: document.getElementById('min-think-time'), // NEW
                maxThinkTime: document.getElementById('max-think-time'), // NEW
                activityBurstChance: document.getElementById('activity-burst-chance'), // NEW
                minBurstActions: document.getElementById('min-burst-actions'), // NEW
                maxBurstActions: document.getElementById('max-burst-actions'), // NEW
                minLullTime: document.getElementById('min-lull-time'), // NEW
                maxLullTime: document.getElementById('max-lull-time'), // NEW
                enableTimeOfDayBias: document.getElementById('enable-time-of-day-bias'), // NEW
                rpcSwitchDelay: document.getElementById('rpc-switch-delay'), // NEW
                walletSwitchDelay: document.getElementById('wallet-switch-delay'), // NEW UI element for walletSwitchDelay
                rpcUrls: document.getElementById('rpc-urls'),
                testRpcBtn: document.getElementById('test-rpc-btn'),
                probSend: document.getElementById('prob-send'),
                probDeploy: document.getElementById('prob-deploy'), // NEW
                probInteract: document.getElementById('prob-interact'), // NEW
                probIdleAction: document.getElementById('prob-idle-action'),
                probBalanceCheck: document.getElementById('prob-balance-check'), // NEW
                probSumWarning: document.getElementById('prob-sum-warning'),
                privateKeys: document.getElementById('private-keys'),
                loadKeysBtn: document.getElementById('load-keys-btn'),
                keysLoadedCount: document.getElementById('keys-loaded-count'),
                walletListDisplay: document.getElementById('wallet-list-display'),
                noWalletsMsg: document.getElementById('no-wallets-msg'),
                recipientMode: document.getElementsByName('recipient-mode'),
                fixedAddressSection: document.getElementById('fixed-address-section'),
                fixedAddress: document.getElementById('fixed-address'),
                listAddressesSection: document.getElementById('list-addresses-section'),
                listAddresses: document.getElementById('list-addresses'),
                loadAddressesFromListBtn: document.getElementById('load-addresses-from-list-btn'),
                listAddressesCount: document.getElementById('list-addresses-count'),
                predefinedAddressesSection: document.getElementById('predefined-addresses-section'),
                predefinedFileInput: document.getElementById('predefined-file-input'),
                loadPredefinedFileBtn: document.getElementById('load-predefined-file-btn'),
                predefinedAddressesInfo: document.getElementById('predefined-addresses-info'),
                predefinedAddressesDisplay: document.getElementById('predefined-addresses-display'),
                predefinedAddressesCount: document.getElementById('predefined-addresses-count'),
                liveLog: document.getElementById('live-log'),
                downloadLogBtn: document.getElementById('download-log-btn'),
                downloadLogCsvBtn: document.getElementById('download-log-csv-btn'), // NEW
                downloadLogJsonBtn: document.getElementById('download-log-json-btn'), // NEW
                clearLogBtn: document.getElementById('clear-log-btn'), // NEW
                summarizeLogBtn: document.getElementById('summarize-log-btn'), // NEW UI element
                progressBar: document.getElementById('progress-bar'),
                progressText: document.getElementById('progress-text'),
                statusDisplay: document.getElementById('status-display'),
                successCount: document.getElementById('success-count'),
                failCount: document.getElementById('fail-count'),
                gasDisplay: document.getElementById('gas-display'),
                walletBalanceChartCanvas: document.getElementById('wallet-balance-chart'),
                actionDistChartCanvas: document.getElementById('action-dist-chart'),
                explainSendTxBtn: document.getElementById('explain-send-tx-btn'),
                geminiModal: document.getElementById('gemini-modal'),
                modalTitle: document.getElementById('modal-title'),
                modalContent: document.getElementById('modal-content'),
                closeModalBtn: document.querySelector('#gemini-modal .close-button'),
                confirmationModal: document.getElementById('confirmation-modal'),
                confirmMessage: document.getElementById('confirm-message'),
                confirmActionBtn: document.getElementById('confirm-action-btn'),
                cancelConfirmBtn: document.getElementById('cancel-confirm-btn'),
                closeConfirmBtn: document.querySelector('#confirmation-modal .close-confirm-button'),
                humanSpikeDisplay: document.getElementById('human-spike-display'), // NEW
                stealthProfileSelector: document.getElementById('stealth-profile'), // NEW UI element
                advanceConsoleToggle: document.getElementById('advance-console-toggle'),
                advanceConsoleSubmenu: document.getElementById('advance-console-submenu'),
                themeToggle: document.getElementById('theme-toggle'), // NEW
                themeToggleIcon: document.getElementById('theme-toggle-icon'), // NEW
                apiKeyInput: document.getElementById('api-key-input'), // NEW
            };

            // Function to enable/disable UI elements
            const setUIEnabled = (enabled) => {
                ui.walletFeatureControls.forEach(control => {
                    control.disabled = !enabled;
                    // Adjust opacity/cursor for radio buttons based on enabled state
                    if (control.type === 'radio' || control.type === 'checkbox') {
                         control.parentElement.style.opacity = enabled ? '1' : '0.6';
                         control.parentElement.style.cursor = enabled ? 'default' : 'not-allowed';
                    }
                });

                // The connect wallet button should ALWAYS be enabled.
                ui.connectWalletBtn.disabled = false;


                // Correctly show/hide recipient sections based on selected mode
                const selectedRecipientMode = Array.from(ui.recipientMode).find(r => r.checked)?.value;
                if (enabled) {
                    ui.fixedAddressSection.classList.toggle('hidden', selectedRecipientMode !== 'fixed');
                    ui.listAddressesSection.classList.toggle('hidden', selectedRecipientMode !== 'list');
                    ui.predefinedAddressesSection.classList.toggle('hidden', selectedRecipientMode !== 'predefined');
                } else {
                    // When disabled, hide all recipient specific sections
                    ui.fixedAddressSection.classList.add('hidden');
                    ui.listAddressesSection.classList.add('hidden');
                    ui.predefinedAddressesSection.classList.add('hidden');
                }

                // Reset specific elements when disabled
                if (!enabled) {
                    ui.privateKeys.value = '';
                    ui.keysLoadedCount.textContent = '';
                    appState.wallets = [];
                    updateWalletBalanceChart(); // Update console's chart
                    // Reset RPC URLs to default if no wallet is connected
                    ui.rpcUrls.value = `https://mainnet.infura.io/v3/YOUR_PROJECT_ID,1\nhttps://rpc.goerli.dev,5`;
                    // Reset action probabilities to default
                    ui.probSend.value = "40"; // New default
                    ui.probDeploy.value = "20"; // NEW default
                    ui.probInteract.value = "20"; // NEW default
                    ui.probIdleAction.value = "10"; // New default
                    ui.probBalanceCheck.value = "10"; // New default
                    // Reset stealth profile to balanced
                    ui.stealthProfileSelector.value = "balanced";
                    injectStealthDefaults(); // Re-inject defaults to reset all fields
                }
            };

            const openGeminiModal = (title, contentHtml) => {
                ui.modalTitle.textContent = title;
                ui.modalContent.innerHTML = contentHtml;
                ui.geminiModal.classList.remove('hidden');
            };

            const closeGeminiModal = () => {
                ui.geminiModal.classList.add('hidden');
                ui.modalContent.innerHTML = '<div class="modal-loader"></div><p class="text-center mt-4">Generating explanation...</p>';
            };

            const openConfirmationModal = (message, callback) => {
                ui.confirmMessage.textContent = message;
                appState.pendingConfirmation = callback;
                ui.confirmationModal.classList.remove('hidden');
            };

            const closeConfirmationModal = () => {
                ui.confirmationModal.classList.add('hidden');
                appState.pendingConfirmation = null;
            };

            const confirmAction = () => {
                if (appState.pendingConfirmation) {
                    appState.pendingConfirmation(true);
                }
                closeConfirmationModal();
            };

            const cancelAction = () => {
                if (appState.pendingConfirmation) {
                    appState.pendingConfirmation(false);
                }
                closeConfirmationModal();
            };

            const log = (message, type = 'info', actionData = {}) => {
                const timestamp = new Date().toLocaleTimeString();
                const logEntryDiv = document.createElement('div');
                logEntryDiv.innerHTML = `<span class="text-gray-500 mr-2">${timestamp}</span> <span class="log-${type}">${message}</span>`;
                ui.liveLog.appendChild(logEntryDiv);
                ui.liveLog.scrollTop = ui.liveLog.scrollHeight;

                appState.logEntries.push({
                    Timestamp: new Date().toISOString(),
                    ChainID: actionData.chainId || '',
                    WalletAddress: actionData.walletAddress || '',
                    Action: actionData.action || 'Log',
                    Status: type.toUpperCase(),
                    Details: message.replace(/<[^>]*>?/gm, '').replace(/,/g, ';'),
                    DelayUsedMs: actionData.delayUsedMs || '', // New log field
                    GasFactorUsed: actionData.gasFactorUsed || '', // New log field
                });
            };

            // Global utility functions for chart labels and tooltips
            const wrapLabel = (str, maxLen = 16) => {
                if (str.length <= maxLen) {
                    return str;
                }
                const words = str.split(' ');
                const lines = [];
                let currentLine = '';
                for (const word of words) {
                    if ((currentLine + ' ' + word).length > maxLen && currentLine.length > 0) {
                        lines.push(currentLine);
                        currentLine = word;
                    } else {
                        currentLine += (currentLine.length === 0 ? '' : ' ') + word;
                    }
                }
                if (currentLine.length > 0) {
                    lines.push(currentLine);
                }
                return lines;
            };

            const mandatoryTooltipConfig = {
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const item = tooltipItems[0];
                                if (!item) return '';
                                let label = item.chart.data.labels[item.dataIndex];
                                return Array.isArray(label) ? label.join(' ') : label;
                            }
                        }
                    }
                }
            };

            const initConsoleCharts = () => {
                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-main') } } },
                    scales: {
                        x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-accent') } },
                        y: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-accent') } }
                    }
                };

                // Destroy existing charts if they exist to prevent re-initialization errors
                if (appState.charts.walletBalance) {
                    appState.charts.walletBalance.destroy();
                }
                appState.charts.walletBalance = new Chart(ui.walletBalanceChartCanvas, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: 'ETH Balance', data: [], backgroundColor: '#60a5fa', borderColor: '#3b82f6', borderWidth: 1 }] },
                    options: { ...chartOptions, indexAxis: 'y' }
                });

                if (appState.charts.actionDist) {
                    appState.charts.actionDist.destroy();
                }
                appState.charts.actionDist = new Chart(ui.actionDistChartCanvas, {
                    type: 'doughnut',
                    data: {
                        // Updated labels for new action types
                        labels: ['Send', 'Deploy', 'Interact', 'Idle', 'Balance Check', 'Skipped'],
                        datasets: [{
                            label: 'Actions',
                            // Updated data array size for 6 categories
                            data: [0, 0, 0, 0, 0, 0],
                            // Updated colors for consistency and new action types
                            backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#a8a29e', '#6366f1', '#ef4444'],
                            borderColor: '#ffffff',
                            borderWidth: 1
                        }]
                    },
                    options: { ...chartOptions, scales: {} }
                });
            };

            const updateWalletBalanceChart = () => {
                const chart = appState.charts.walletBalance;
                chart.data.labels = appState.wallets.map(w => `...${w.address.slice(-6)}`);
                chart.data.datasets[0].data = appState.wallets.map(w => w.balance);
                chart.update();

                if (appState.wallets.length > 0) {
                    ui.noWalletsMsg.classList.add('hidden');
                    ui.walletListDisplay.innerHTML = appState.wallets.map(w =>
                        `<li>Wallet: ...${w.address.slice(-10)} | Balance: ${w.balance} ETH</li>`
                    ).join('');
                } else {
                    ui.noWalletsMsg.classList.remove('hidden');
                    ui.walletListDisplay.innerHTML = '<li id="no-wallets-msg">No wallets loaded yet.</li>';
                }
            };

            const updateActionDistChart = (actionType) => {
                appState.stats.actionCounts[actionType]++;
                const chart = appState.charts.actionDist;
                // Update dataMap for new labels
                const dataMap = {
                    send: 0, deploy: 1, interact: 2, idle: 3, 'balance-check': 4, skipped: 5
                };
                if (dataMap[actionType] !== undefined) {
                    chart.data.datasets[0].data[dataMap[actionType]] = appState.stats.actionCounts[actionType];
                    chart.update();
                }
            };


            const loadConfiguration = () => {
                const probInputs = document.querySelectorAll('.prob-input');
                let totalProb = 0;
                probInputs.forEach(input => totalProb += parseInt(input.value) || 0);

                if (totalProb !== 100) {
                    ui.probSumWarning.classList.remove('hidden');
                    return false;
                } else {
                    ui.probSumWarning.classList.add('hidden');
                }

                const minAmount = parseFloat(ui.minAmount.value);
                const maxAmount = parseFloat(ui.maxAmount.value);
                if (minAmount > maxAmount) {
                    log('Error: Minimum amount cannot be greater than maximum amount.', 'error');
                    return false;
                }

                const minDelay = parseInt(ui.minDelay.value);
                const maxDelay = parseInt(ui.maxDelay.value);
                if (minDelay > maxDelay) {
                    log('Error: Minimum delay cannot be greater than maximum delay.', 'error');
                    return false;
                }

                const minGasFactor = parseFloat(ui.minGasFactor.value);
                const maxGasFactor = parseFloat(ui.maxGasFactor.value);
                if (minGasFactor > maxGasFactor || minGasFactor <= 0) {
                    log('Error: Minimum gas factor must be greater than 0 and less than or equal to maximum gas factor.', 'error');
                    return false;
                }

                // NEW: Think Time validation
                const minThinkTime = parseInt(ui.minThinkTime.value);
                const maxThinkTime = parseInt(ui.maxThinkTime.value);
                if (minThinkTime > maxThinkTime) {
                    log('Error: Minimum Think Time cannot be greater than maximum Think Time.', 'error');
                    return false;
                }

                // NEW: Activity Burst/Lull validation
                const minBurstActions = parseInt(ui.minBurstActions.value);
                const maxBurstActions = parseInt(ui.maxBurstActions.value);
                if (minBurstActions > maxBurstActions) {
                    log('Error: Minimum Burst Actions cannot be greater than maximum Burst Actions.', 'error');
                    return false;
                }
                const minLullTime = parseInt(ui.minLullTime.value);
                const maxLullTime = parseInt(ui.maxLullTime.value);
                if (minLullTime > maxLullTime) {
                    log('Error: Minimum Lull Time cannot be greater than maximum Lull Time.', 'error');
                    return false;
                }


                appState.config = {
                    maxTxnsPerWallet: parseInt(ui.maxTxnsPerWallet.value) || 3,
                    walletIdleChance: parseInt(ui.walletIdleChance.value) || 25,
                    minAmount: minAmount || 0.0001,
                    maxAmount: maxAmount || 0.0002,
                    minDelay: minDelay * 1000 || 10000,
                    maxDelay: maxDelay * 1000 || 30000,
                    gasMultiplier: parseFloat(ui.gasMultiplier.value) || 2,
                    minGasFactor: minGasFactor || 0.9,
                    maxGasFactor: maxGasFactor || 1.1,
                    blockLookback: parseInt(ui.blockLookback.value) || 100,
                    probJitterFactor: parseInt(ui.probJitterFactor.value) || 5, // NEW config
                    simulatedErrorChance: parseInt(ui.simulatedErrorChance.value) || 0, // NEW config
                    thinkTimeChance: parseInt(ui.thinkTimeChance.value) || 10, // NEW config
                    minThinkTime: minThinkTime * 1000 || 60000, // Convert to ms
                    maxThinkTime: maxThinkTime * 1000 || 120000, // Convert to ms
                    activityBurstChance: parseInt(ui.activityBurstChance.value) || 50, // NEW config
                    minBurstActions: minBurstActions || 2, // NEW config
                    maxBurstActions: maxBurstActions || 5, // NEW config
                    minLullTime: minLullTime * 1000 || 300000, // Convert to ms
                    maxLullTime: maxLullTime * 1000 || 900000, // Convert to ms
                    enableTimeOfDayBias: ui.enableTimeOfDayBias.checked, // NEW config
                    rpcSwitchDelay: parseInt(ui.rpcSwitchDelay.value) * 1000 || 5000, // NEW config
                    walletSwitchDelay: parseInt(ui.walletSwitchDelay.value) * 1000 || 5000, // NEW config
                    recipientMode: Array.from(ui.recipientMode).find(r => r.checked).value,
                    fixedAddress: ui.fixedAddress.value.trim(),
                    probabilities: {
                        send: parseInt(ui.probSend.value) || 40, // Updated default
                        deploy: parseInt(ui.probDeploy.value) || 20, // NEW default
                        interact: parseInt(ui.probInteract.value) || 20, // NEW default
                        idle: parseInt(ui.probIdleAction.value) || 10, // Updated default
                        'balance-check': parseInt(ui.probBalanceCheck.value) || 10, // NEW default
                    }
                };

                appState.rpcConfigs = ui.rpcUrls.value.split('\n').map(line => {
                    const [url, chainIdStr] = line.split(',').map(s => s.trim());
                    const chainId = parseInt(chainIdStr);
                    if (!url || isNaN(chainId)) {
                        log(`Warning: Invalid RPC entry ignored: "${line}". Format should be "URL,ChainID".`, 'warning');
                        return null;
                    }
                    return { url, chainId: chainId };
                }).filter(Boolean);

                return true;
            };

            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // Modified chooseAction to use per-wallet probabilities
            const chooseAction = (walletSessionProbs) => {
                const rand = Math.random() * 100;
                let cumulativeProb = 0;

                if (rand < (cumulativeProb += walletSessionProbs.send)) return 'send';
                if (rand < (cumulativeProb += walletSessionProbs.deploy)) return 'deploy'; // NEW
                if (rand < (cumulativeProb += walletSessionProbs.interact)) return 'interact'; // NEW
                if (rand < (cumulativeProb += walletSessionProbs.idle)) return 'idle-action';
                if (rand < (cumulativeProb += walletSessionProbs['balance-check'])) return 'balance-check';
                return 'idle-action'; // Fallback, should not be reached if sum is 100
            };

            const scanRecentBlocks = async (rpc, chainId) => {
                appState.currentRecipientPool[chainId] = appState.currentRecipientPool[chainId] || [];
                const provider = new ethers.JsonRpcProvider(rpc);
                log(`Scanning ${appState.config.blockLookback} blocks on Chain ID ${chainId}...`, 'info');
                try {
                    const currentBlockNumber = await provider.getBlockNumber();
                    const startBlock = Math.max(0, currentBlockNumber - appState.config.blockLookback);
                    const newAddresses = new Set();

                    for (let blk = startBlock; blk <= currentBlockNumber; blk++) {
                        const block = await provider.getBlock(blk, true);
                        if (block && block.transactions) {
                            block.transactions.forEach(tx => {
                                if (tx.to && ethers.isAddress(tx.to)) {
                                    newAddresses.add(tx.to);
                                }
                            });
                        }
                    }

                    const existingAddresses = new Set(appState.currentRecipientPool[chainId]);
                    newAddresses.forEach(addr => existingAddresses.add(addr));
                    appState.currentRecipientPool[chainId] = Array.from(existingAddresses);
                    log(`Found ${newAddresses.size} new addresses. Total recipients for chain ${chainId}: ${appState.currentRecipientPool[chainId].length}`, 'success');
                } catch (error) {
                    log(`Failed to scan blocks for chain ${chainId}: ${error.message}`, 'error');
                }
            };

            async function callGeminiApi(prompt) {
                log('Calling Gemini API for explanation...', 'info');
                openGeminiModal('Getting Explanation...', '<div class="modal-loader"></div><p class="text-center mt-4">Generating explanation...</p>');
                const apiKey = ui.apiKeyInput.value.trim() || ""; // Use user provided key, or empty string
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }]
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const explanation = result.candidates[0].content.parts[0].text;
                        ui.modalTitle.textContent = "Gemini Explanation";
                        ui.modalContent.innerHTML = `<p>${explanation.replace(/\n/g, '<br>')}</p>`;
                        return explanation;
                    } else {
                        ui.modalTitle.textContent = "Gemini Explanation Error";
                        ui.modalContent.innerHTML = `<p class="text-red-500">No explanation generated. The model might have been unable to process the request or returned an unexpected format.</p>`;
                        return "No explanation generated.";
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    ui.modalTitle.textContent = "Gemini API Error";
                    ui.modalContent.innerHTML = `<p class="text-red-500">Failed to get explanation: ${error.message}. Please check your network connection or try again later.</p>`;
                    return `Failed to get explanation: ${error.message}.`;
                }
            }


            const loadWallets = async () => {
                const keys = ui.privateKeys.value.split('\n').map(k => k.trim()).filter(Boolean);
                if (keys.length === 0) {
                    log('No private keys provided. Please paste private keys into the text area.', 'error');
                    return;
                }
                if (appState.rpcConfigs.length === 0) {
                    log('Please provide at least one RPC URL and Chain ID in Configuration.', 'error');
                    return;
                }

                log(`Attempting to load ${keys.length} wallets and check balances...`, 'info');
                appState.wallets = [];
                ui.keysLoadedCount.textContent = `Loading 0 / ${keys.length}...`;

                const defaultProvider = new ethers.JsonRpcProvider(appState.rpcConfigs[0].url);
                const baseProbs = appState.config.probabilities;
                const jitterFactor = appState.config.probJitterFactor / 100; // Convert % to decimal

                for (let i = 0; i < keys.length; i++) {
                    try {
                        const wallet = new ethers.Wallet(keys[i], defaultProvider);
                        const balanceWei = await defaultProvider.getBalance(wallet.address);
                        const balanceEth = ethers.formatEther(balanceWei);

                        // Calculate per-wallet probabilities with jitter
                        let sendJitter = Stealth.getRandomInRange(-jitterFactor, jitterFactor) * baseProbs.send;
                        let deployJitter = Stealth.getRandomInRange(-jitterFactor, jitterFactor) * baseProbs.deploy; // NEW
                        let interactJitter = Stealth.getRandomInRange(-jitterFactor, jitterFactor) * baseProbs.interact; // NEW
                        let idleJitter = Stealth.getRandomInRange(-jitterFactor, jitterFactor) * baseProbs.idle;
                        let balanceCheckJitter = Stealth.getRandomInRange(-jitterFactor, jitterFactor) * baseProbs['balance-check'];

                        let currentSend = Math.max(0, baseProbs.send + sendJitter);
                        let currentDeploy = Math.max(0, baseProbs.deploy + deployJitter); // NEW
                        let currentInteract = Math.max(0, baseProbs.interact + interactJitter); // NEW
                        let currentIdle = Math.max(0, baseProbs.idle + idleJitter);
                        let currentBalanceCheck = Math.max(0, baseProbs['balance-check'] + balanceCheckJitter);

                        // Normalize probabilities to sum to 100
                        const sum = currentSend + currentDeploy + currentInteract + currentIdle + currentBalanceCheck; // NEW sum
                        const walletSessionProbs = {
                            send: (currentSend / sum) * 100,
                            deploy: (currentDeploy / sum) * 100, // NEW
                            interact: (currentInteract / sum) * 100, // NEW
                            idle: (currentIdle / sum) * 100,
                            'balance-check': (currentBalanceCheck / sum) * 100
                        };

                        appState.wallets.push({
                            privateKey: keys[i],
                            address: wallet.address,
                            balance: parseFloat(balanceEth).toFixed(6),
                            sessionProbabilities: walletSessionProbs // Store per-wallet probabilities
                        });
                        ui.keysLoadedCount.textContent = `Loaded ${i + 1} / ${keys.length} wallets.`;
                    } catch (error) {
                        log(`Failed to load key #${i+1}: Invalid key or RPC issue - ${error.message}`, 'error');
                    }
                }

                log(`Successfully loaded ${appState.wallets.length} wallets and their balances.`, 'success');
                ui.keysLoadedCount.textContent = `Loaded ${appState.wallets.length} wallets.`;
                updateWalletBalanceChart();
            };

            const testRpcConnections = async () => {
                loadConfiguration();
                if (appState.rpcConfigs.length === 0) {
                    log('No RPC URLs configured to test.', 'warning');
                    return;
                }

                log('Testing RPC connections...', 'info');
                for (const rpcConfig of appState.rpcConfigs) {
                    const provider = new ethers.JsonRpcProvider(rpcConfig.url);
                    try {
                        const network = await provider.getNetwork();
                        const blockNumber = await provider.getBlockNumber();
                        if (network.chainId === BigInt(rpcConfig.chainId)) {
                            log(`‚úÖ RPC ${rpcConfig.url} connected (Chain ID: ${network.chainId}, Latest Block: ${blockNumber})`, 'success');
                        } else {
                            log(`‚ö†Ô∏è RPC ${rpcConfig.url} connected but Chain ID mismatch. Configured: ${rpcConfig.chainId}, Actual: ${network.chainId}. Latest Block: ${blockNumber}.`, 'warning');
                        }
                    }
                    catch (error) {
                        log(`‚ùå Failed to connect to RPC ${rpcConfig.url}: ${error.message}`, 'error');
                    }
                }
                log('RPC connection testing complete.', 'info');
            };

            const loadAddressesFromList = () => {
                const addressesInput = ui.listAddresses.value.split('\n').map(addr => addr.trim()).filter(Boolean);
                const validAddresses = [];
                let invalidCount = 0;

                addressesInput.forEach(addr => {
                    if (ethers.isAddress(addr)) {
                        validAddresses.push(addr);
                    } else {
                        invalidCount++;
                        log(`Invalid address in list: "${addr}"`, 'warning');
                    }
                });

                appState.manualRecipientList = validAddresses;
                ui.listAddressesCount.textContent = `Loaded ${validAddresses.length} valid addresses. ${invalidCount > 0 ? `(${invalidCount} invalid ignored)` : ''}`;
                if (validAddresses.length > 0) {
                    log(`Successfully loaded ${validAddresses.length} recipient addresses from list.`, 'success');
                } else {
                    log('No valid addresses loaded from list.', 'warning');
                }
            };

            const loadPredefinedListFromFile = () => {
                const file = ui.predefinedFileInput.files[0];
                if (!file) {
                    log('No file selected for predefined list.', 'warning');
                    ui.predefinedAddressesInfo.textContent = 'No file loaded.';
                    ui.predefinedAddressesCount.textContent = '';
                    appState.predefinedRecipientList = [];
                    updatePredefinedAddressesDisplay();
                    return;
                }

                ui.predefinedAddressesInfo.textContent = `Loading file: ${file.name}...`;
                log(`Attempting to load predefined addresses from ${file.name}...`, 'info');

                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    const addresses = content.split(/\r?\n/).map(line => line.trim()).filter(Boolean);
                    const validAddresses = [];
                    let invalidCount = 0;

                    addresses.forEach(addr => {
                        if (ethers.isAddress(addr)) {
                            validAddresses.push(addr);
                        } else {
                            invalidCount++;
                            log(`Invalid address in predefined file: "${addr}"`, 'warning');
                        }
                    });

                    appState.predefinedRecipientList = validAddresses;
                    ui.predefinedAddressesInfo.textContent = `File loaded: ${file.name}`;
                    ui.predefinedAddressesCount.textContent = `List contains ${validAddresses.length} valid addresses. ${invalidCount > 0 ? `(${invalidCount} invalid ignored)` : ''}`;
                    if (validAddresses.length > 0) {
                        log(`Successfully loaded ${validAddresses.length} addresses from "${file.name}".`, 'success');
                    } else {
                        log(`No valid addresses found in "${file.name}".`, 'warning');
                    }
                    updatePredefinedAddressesDisplay();
                };

                reader.onerror = (e) => {
                    log(`Error reading file: ${e.target.error.name}`, 'error');
                    ui.predefinedAddressesInfo.textContent = 'Error loading file.';
                    ui.predefinedAddressesCount.textContent = '';
                    appState.predefinedRecipientList = [];
                    updatePredefinedAddressesDisplay();
                };

                reader.readAsText(file);
            };

            const updatePredefinedAddressesDisplay = () => {
                ui.predefinedAddressesDisplay.innerHTML = '';
                if (appState.predefinedRecipientList.length > 0) {
                    appState.predefinedRecipientList.forEach(addr => {
                        const li = document.createElement('li');
                        li.textContent = addr;
                        ui.predefinedAddressesDisplay.appendChild(li);
                    });
                } else {
                    ui.predefinedAddressesDisplay.innerHTML = '<li>No predefined addresses loaded.</li>';
                }
            };

            /**
             * Exports the stored contract memory to a JSON file.
             */
            const exportContractMemory = () => {
                if (Object.keys(walletChainContracts).length === 0) {
                    openGeminiModal('No Contract Memory', '<p class="text-accent">There is no contract memory to export yet. Deploy some contracts first!</p>');
                    return;
                }
                const jsonContent = JSON.stringify(walletChainContracts, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `farmlabs_contract_memory_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                log('Contract memory exported as JSON.', 'info');
            };

            /**
             * Imports contract memory from a selected JSON file.
             */
            const importContractMemory = () => {
                const file = ui.importContractMemoryInput.files[0];
                if (!file) {
                    log('No file selected for importing contract memory.', 'warning');
                    return;
                }

                log(`Attempting to import contract memory from ${file.name}...`, 'info');

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        // Basic validation: ensure it's an object and contains wallet addresses as keys
                        if (typeof importedData === 'object' && importedData !== null && !Array.isArray(importedData)) {
                            walletChainContracts = { ...walletChainContracts, ...importedData }; // Merge imported data
                            localStorage.setItem(CONTRACT_STORAGE_KEY, JSON.stringify(walletChainContracts));
                            log(`Successfully imported contract memory from "${file.name}". Merged with existing data.`, 'success');
                        } else {
                            log(`Invalid contract memory file format. Expected a JSON object.`, 'error');
                        }
                    } catch (error) {
                        log(`Error parsing imported contract memory file: ${error.message}`, 'error');
                    }
                };
                reader.onerror = (e) => {
                    log(`Error reading file for import: ${e.target.error.name}`, 'error');
                };
                reader.readAsText(file);
            };


            const startInteraction = async () => {
                openConfirmationModal('Are you sure you want to start Blockchain Interaction? Ensure your settings and keys are for test purposes only, as this involves real blockchain interactions.', async (confirmed) => {
                    if (!confirmed) {
                        log('Interaction start cancelled by user.', 'info');
                        return;
                    }

                    if (!loadConfiguration()) {
                        log('Configuration is invalid. Please fix errors before starting.', 'error');
                        return;
                    }

                    if (appState.wallets.length === 0) {
                        log('Please load wallets first.', 'error');
                        return;
                    }
                    if (appState.rpcConfigs.length === 0) {
                        log('Please provide at least one RPC URL and Chain ID.', 'error');
                        return;
                    }
                    if (appState.config.recipientMode === 'fixed' && !ethers.isAddress(appState.config.fixedAddress)) {
                        log('Invalid fixed recipient address.', 'error');
                        return;
                    }
                    if (appState.config.recipientMode === 'list' && appState.manualRecipientList.length === 0) {
                        log('Recipient list is empty. Please load addresses into the list or choose another recipient mode.', 'error');
                        return;
                    }
                    if (appState.config.recipientMode === 'predefined' && appState.predefinedRecipientList.length === 0) {
                        log('Predefined recipient list is empty. Please load a CSV file with addresses.', 'error');
                        return;
                    }
                    if (appState.config.recipientMode === 'self-interact' && appState.wallets.length < 2) {
                        log('To use "interact with each other" mode, you need at least 2 loaded wallets.', 'error');
                        return;
                    }
                    
                    appState.isRunning = true;
                    appState.stopFlag = false;
                    // Reset action counts for all action types
                    appState.stats = { totalActions: 0, successfulActions: 0, failedActions: 0, actionCounts: { send: 0, deploy: 0, interact: 0, idle: 0, 'balance-check': 0, skipped: 0 } };
                    appState.logEntries = [];
                    // Update chart with new labels and reset data
                    appState.charts.actionDist.data.labels = ['Send', 'Deploy', 'Interact', 'Idle', 'Balance Check', 'Skipped'];
                    appState.charts.actionDist.data.datasets[0].data = [0, 0, 0, 0, 0, 0];
                    appState.charts.actionDist.update();


                    ui.startBtn.disabled = true;
                    ui.stopBtn.disabled = false;
                    ui.statusDisplay.textContent = 'Running';
                    ui.successCount.textContent = appState.stats.successfulActions.toString();
                    ui.failCount.textContent = appState.stats.failedActions.toString();
                    ui.progressText.textContent = '0';
                    ui.progressBar.style.width = `100%`;


                    log(`Starting Blockchain Interaction process across ${appState.rpcConfigs.length} chains and ${appState.wallets.length} wallets.`, 'info');

                    // Pre-scan all RPCs for addresses for the 'pool' mode
                    if (appState.config.recipientMode === 'pool') {
                        log('Pre-scanning all configured chains for recipient addresses for the dynamic pool...', 'info');
                        for (const rpcConfig of appState.rpcConfigs) {
                            await scanRecentBlocks(rpcConfig.url, rpcConfig.chainId);
                        }
                        log('Pre-scanning complete.', 'info');
                    }

                    // Main Interaction loop: continuously runs until stop button is clicked
                    while (appState.isRunning && !appState.stopFlag) {
                        // Randomly select an RPC configuration for this session
                        const rpcConfigIndex = Math.floor(Math.random() * appState.rpcConfigs.length);
                        const rpcConfig = appState.rpcConfigs[rpcConfigIndex];
                        const rpcUrl = rpcConfig.url;
                        const chainId = rpcConfig.chainId;
                        const provider = new ethers.JsonRpcProvider(rpcUrl);

                        // NEW: RPC Switch Delay
                        if (appState.rpcConfigs.length > 1 && appState.config.rpcSwitchDelay > 0) {
                            log(`Pausing for RPC switch delay (${appState.config.rpcSwitchDelay / 1000}s)...`, 'info');
                            await sleep(appState.config.rpcSwitchDelay);
                        }

                        // Randomly select a wallet for this session
                        const walletInfoIndex = Math.floor(Math.random() * appState.wallets.length);
                        const walletInfo = appState.wallets[walletInfoIndex];
                        const walletAddress = walletInfo.address;
                        let wallet = new ethers.Wallet(walletInfo.privateKey, provider);

                        log(`üåê Initiating session for Wallet ...${walletAddress.slice(-6)} on Chain ID ${chainId} (${rpcUrl})...`, 'info');

                        // NEW: Wallet Switch Delay
                        if (appState.wallets.length > 1 && appState.config.walletSwitchDelay > 0) {
                            log(`Pausing for wallet switch delay (${appState.config.walletSwitchDelay / 1000}s)...`, 'info');
                            await sleep(appState.config.walletSwitchDelay);
                        }

                        // Check for idle chance for the wallet session
                        if (Math.random() * 100 < appState.config.walletIdleChance) {
                            log(`Wallet ...${walletAddress.slice(-6)} is idle this session on Chain ID ${chainId}.`, 'info', { chainId, walletAddress, action: 'idle' });
                            updateActionDistChart('idle');
                            const delay = Stealth.generateLogNormalDelay(appState.config.minDelay, appState.config.maxDelay);
                            await sleep(delay);
                            continue; // Move to next wallet/chain session
                        }

                        // Balance check for the current wallet on the current chain
                        try {
                            const balanceWei = await provider.getBalance(walletAddress);
                            if (balanceWei < ethers.parseEther("0.001")) { // Ensure sufficient balance for gas
                                log(`Skipping wallet ...${walletAddress.slice(-6)} on Chain ID ${chainId} due to critically low balance (${ethers.formatEther(balanceWei)} ETH).`, 'warning', { chainId, walletAddress, action: 'skipped' });
                                updateActionDistChart('skipped');
                                const delay = Stealth.generateLogNormalDelay(appState.config.minDelay, appState.config.maxDelay);
                                await sleep(delay); // Add delay even for skipped
                                continue; // Move to next wallet/chain session
                            } else if (balanceWei < ethers.parseEther("0.005")) { // Warning for slightly low balance
                                 log(`Wallet ...${walletAddress.slice(-6)} on Chain ID ${chainId} has low balance (${ethers.formatEther(balanceWei)} ETH).`, 'warning', { chainId, walletAddress, action: 'info' });
                            }
                        } catch (balanceError) {
                            log(`Failed to check balance for ...${walletAddress.slice(-6)} on Chain ID ${chainId}: ${balanceError.message}`, 'error', { chainId, walletAddress, action: 'skipped' });
                            updateActionDistChart('skipped');
                            const delay = Stealth.generateLogNormalDelay(appState.config.minDelay, appState.config.maxDelay);
                            await sleep(delay);
                            continue; // Move to next wallet/chain session
                        }

                        // NEW: Activity Bursts & Lulls logic
                        let actionsForWallet;
                        let currentSessionType = 'normal';
                        if (Math.random() * 100 < appState.config.activityBurstChance) {
                            actionsForWallet = Math.floor(Stealth.getRandomInRange(appState.config.minBurstActions, appState.config.maxBurstActions + 1));
                            currentSessionType = 'burst';
                            log(`Wallet ...${walletAddress.slice(-6)} entered an activity burst, performing ${actionsForWallet} actions.`, 'info');
                        } else {
                            actionsForWallet = Math.floor(Stealth.getRandomInRange(1, appState.config.maxTxnsPerWallet + 1));
                        }
                        log(`Wallet ...${walletAddress.slice(-6)} will perform ${actionsForWallet} action(s) on Chain ID ${chainId}.`, 'info');


                        for (let i = 1; i <= actionsForWallet; i++) {
                            if (appState.stopFlag) break; // Break from inner loop if stop requested

                            appState.stats.totalActions++;
                            ui.progressText.textContent = `${appState.stats.totalActions}`;
                            ui.progressBar.style.width = `100%`;

                            // Gas Price Check (still relevant for skipping if too high, before applying random factor)
                            let currentGasPrice = null;
                            let maxPriorityFeePerGas = null;
                            let maxFeePerGas = null;

                            try {
                                const feeData = await provider.getFeeData();
                                currentGasPrice = feeData.gasPrice; // For legacy transactions
                                maxPriorityFeePerGas = feeData.maxPriorityFeePerGas; // For EIP-1559
                                maxFeePerGas = feeData.maxFeePerGas; // For EIP-1559

                                ui.gasDisplay.textContent = `${(Number(ethers.formatUnits(currentGasPrice || maxFeePerGas, 'gwei'))).toFixed(2)} gwei`;

                                // High Gas Price Multiplier Check
                                const thresholdGasPrice = currentGasPrice ? (currentGasPrice * BigInt(Math.round(appState.config.gasMultiplier * 100))) / BigInt(100) : null;
                                const thresholdMaxFeePerGas = maxFeePerGas ? (maxFeePerGas * BigInt(Math.round(appState.config.gasMultiplier * 100))) / BigInt(100) : null;

                                if ((currentGasPrice && thresholdGasPrice && currentGasPrice > thresholdGasPrice) ||
                                    (maxFeePerGas && thresholdMaxFeePerGas && maxFeePerGas > thresholdMaxFeePerGas)) {
                                    log(`Gas price (${(Number(ethers.formatUnits(currentGasPrice || maxFeePerGas, 'gwei'))).toFixed(2)} gwei) is too high. Skipping action for ...${walletAddress.slice(-6)} on Chain ID ${chainId}.`, 'warning', { chainId, walletAddress, action: 'skipped' });
                                    updateActionDistChart('skipped');
                                    // Breaking the inner loop, will move to the next wallet/chain session.
                                    break;
                                }
                            } catch (gasError) {
                                log(`Failed to get gas price for Chain ID ${chainId}: ${gasError.message}. Proceeding without high gas check.`, 'warning', { chainId, walletAddress, action: 'skipped' });
                            }
                            
                            // Choose action using per-wallet probabilities
                            const chosenBehavior = chooseAction(walletInfo.sessionProbabilities);
                            log(`[Action ${i}/${actionsForWallet}] Wallet ...${walletAddress.slice(-6)} chose to: ${chosenBehavior.toUpperCase()}`, 'info', { chainId, walletAddress, action: chosenBehavior });

                            let actionSuccess = false;
                            let delayUsed = 0; // Initialize delayUsed

                            switch (chosenBehavior) {
                                case "send":
                                    let recipientAddress;
                                    const currentChainRecipientPool = appState.currentRecipientPool[chainId];
                                    
                                    if (appState.config.recipientMode === 'fixed') {
                                        recipientAddress = ui.fixedAddress.value.trim();
                                        if (!ethers.isAddress(recipientAddress)) {
                                            log(`Fixed recipient address "${recipientAddress}" is invalid. Skipping send.`, 'error', { chainId, walletAddress, action: 'send' });
                                            updateActionDistChart('skipped');
                                            break;
                                        }
                                    } else if (appState.config.recipientMode === 'list') {
                                        if (appState.manualRecipientList.length === 0) {
                                            log(`Recipient list is empty. Skipping send for wallet ...${walletAddress.slice(-6)}.`, 'warning', { chainId, walletAddress, action: 'send' });
                                            updateActionDistChart('skipped');
                                            break;
                                        }
                                        recipientAddress = appState.manualRecipientList[Math.floor(Math.random() * appState.manualRecipientList.length)];
                                    }
                                    else if (appState.config.recipientMode === 'predefined') {
                                        if (appState.predefinedRecipientList.length === 0) {
                                            log(`Predefined recipient list is empty. Skipping send for wallet ...${walletAddress.slice(-6)}.`, 'warning', { chainId, walletAddress, action: 'send' });
                                            updateActionDistChart('skipped');
                                            break;
                                        }
                                        recipientAddress = appState.predefinedRecipientList[Math.floor(Math.random() * appState.predefinedRecipientList.length)];
                                    }
                                    else if (appState.config.recipientMode === 'self-interact') {
                                        const otherWallets = appState.wallets.filter(w => w.address.toLowerCase() !== walletAddress.toLowerCase());
                                        if (otherWallets.length === 0) {
                                            log(`No other loaded wallets to interact with. Skipping send for wallet ...${walletAddress.slice(-6)}.`, 'warning', { chainId, walletAddress, action: 'send' });
                                            updateActionDistChart('skipped');
                                            break;
                                        }
                                        recipientAddress = otherWallets[Math.floor(Math.random() * otherWallets.length)].address;
                                        log(`Sending to another loaded wallet: ${recipientAddress.slice(0,6)}...${recipientAddress.slice(-4)}`, 'info');
                                    }
                                    else if (appState.config.recipientMode === 'pool') {
                                        // Fallback logic for dynamic pool if no external addresses are found for the current chain
                                        if (currentChainRecipientPool && currentChainRecipientPool.length > 0) {
                                            recipientAddress = currentChainRecipientPool[Math.floor(Math.random() * currentChainRecipientPool.length)];
                                        } else {
                                            // If pool is empty, fall back to loaded wallets
                                            const otherWallets = appState.wallets.filter(w => w.address.toLowerCase() !== walletAddress.toLowerCase());
                                            if (otherWallets.length > 0) {
                                                recipientAddress = otherWallets[Math.floor(Math.random() * otherWallets.length)].address;
                                                log(`Dynamic pool empty for Chain ID ${chainId}. Falling back to sending to another loaded wallet: ${recipientAddress.slice(0,6)}...${recipientAddress.slice(-4)}`, 'info');
                                            } else {
                                                log(`Dynamic pool empty and no other loaded wallets to interact with. Skipping send for wallet ...${walletAddress.slice(-6)}.`, 'warning', { chainId, walletAddress, action: 'send' });
                                                updateActionDistChart('skipped');
                                                break;
                                            }
                                        }
                                    } else {
                                        log(`No valid recipient selection for 'send' action. Skipping.`, 'warning', { chainId, walletAddress, action: 'send' });
                                        updateActionDistChart('skipped');
                                        break;
                                    }


                                    const amount = Stealth.getRandomInRange(appState.config.minAmount, appState.config.maxAmount);
                                    const tx = {
                                        to: recipientAddress,
                                        value: ethers.parseEther(amount.toFixed(12))
                                    };

                                    // Apply random gas factor
                                    const randomGasFactor = Stealth.getRandomInRange(appState.config.minGasFactor, appState.config.maxGasFactor);
                                    if (maxFeePerGas && maxPriorityFeePerGas) { // EIP-1559 chain
                                        // Apply random factor to base fee and priority fee
                                        tx.maxFeePerGas = (maxFeePerGas * BigInt(Math.round(randomGasFactor * 100))) / BigInt(100);
                                        tx.maxPriorityFeePerGas = (maxPriorityFeePerGas * BigInt(Math.round(randomGasFactor * 100))) / BigInt(100);
                                        // Ensure maxFeePerGas is at least maxPriorityFeePerGas
                                        if (tx.maxFeePerGas < tx.maxPriorityFeePerGas) {
                                            tx.maxFeePerGas = tx.maxPriorityFeePerGas + ethers.parseUnits('1', 'gwei'); // Add a small buffer if needed
                                        }
                                    } else if (currentGasPrice) { // Legacy chain
                                        tx.gasPrice = (currentGasPrice * BigInt(Math.round(randomGasFactor * 100))) / BigInt(100);
                                    }
                                    log(`Attempting to send with random gas factor: x${randomGasFactor.toFixed(2)}`, 'info');

                                    try {
                                        // Simulate random transaction error
                                        if (Math.random() * 100 < appState.config.simulatedErrorChance) {
                                            throw new Error("Simulated network error: Transaction dropped/failed.");
                                        }

                                        log(`Sending ${amount.toFixed(6)} ETH to ${recipientAddress.slice(0,6)}...${recipientAddress.slice(-4)}...`, 'info');
                                        const txResponse = await wallet.sendTransaction(tx);
                                        log(`Tx sent! Hash: <a href="https://etherscan.io/tx/${txResponse.hash}" target="_blank" class="underline">${txResponse.hash.slice(0,6)}...${txResponse.hash.slice(-4)}</a><button class="log-copy-btn" data-tx-hash="${txResponse.hash}">üìã</button>`, 'success', { chainId, walletAddress, action: 'send', gasFactorUsed: randomGasFactor });

                                        await txResponse.wait();
                                        log(`Tx confirmed!`, 'success');
                                        actionSuccess = true;
                                    } catch (error) {
                                    if (error.message.includes("Simulated network error")) {
                                            log(`Tx failed: ${error.message}`, 'error', { chainId, walletAddress, action: 'send', gasFactorUsed: randomGasFactor });
                                        } else {
                                            log(`Tx failed: ${error.message}`, 'error', { chainId, walletAddress, action: 'send', gasFactorUsed: randomGasFactor });
                                        }
                                    }
                                    updateActionDistChart('send'); // Update chart for send action
                                    break;

                                case "deploy": // NEW action
                                    const deployedContract = await deployRandomContract(wallet, provider, chainId);
                                    if (deployedContract) {
                                        actionSuccess = true;
                                    }
                                    updateActionDistChart('deploy'); // Update chart for deploy action
                                    break;

                                case "interact": // NEW action
                                    const allContractsOnChain = getAllContractsByChain(chainId);
                                    const targetContract = pickRandom(allContractsOnChain);
                                    if (targetContract) {
                                        await interactContract(wallet, targetContract);
                                        actionSuccess = true;
                                    } else {
                                        log(`No contracts deployed on Chain ID ${chainId} to interact with. Skipping interaction for wallet ...${walletAddress.slice(-6)}.`, 'warning', { chainId, walletAddress, action: 'interact' });
                                        updateActionDistChart('skipped');
                                    }
                                    updateActionDistChart('interact'); // Update chart for interact action
                                    break;

                                case "idle-action":
                                    log(`Wallet ...${walletAddress.slice(-6)} is idling for this action.`, 'info', { chainId, walletAddress, action: 'idle' });
                                    updateActionDistChart('idle');
                                    actionSuccess = true;
                                    break;

                                case "balance-check": // NEW action
                                    try {
                                        const currentBalanceWei = await provider.getBalance(walletAddress);
                                        log(`Wallet ...${walletAddress.slice(-6)} checked balance: ${ethers.formatEther(currentBalanceWei).slice(0, 8)} ETH`, 'info', { chainId, walletAddress, action: 'balance-check' });
                                        actionSuccess = true;
                                    } catch (error) {
                                        log(`Failed to check balance for ...${walletAddress.slice(-6)}: ${error.message}`, 'error', { chainId, walletAddress, action: 'balance-check' });
                                    }
                                    updateActionDistChart('balance-check');
                                    break;
                            }

                            if (actionSuccess) {
                                appState.stats.successfulActions++;
                            } else {
                                appState.stats.failedActions++;
                            }
                            // Update counts on UI immediately after each action attempt
                            ui.successCount.textContent = appState.stats.successfulActions.toString();
                            ui.failCount.textContent = appState.stats.failedActions.toString();
                            // updateActionDistChart(chosenBehavior); // This is already called inside each case

                            try {
                                const newBalanceWei = await provider.getBalance(wallet.address);
                                walletInfo.balance = parseFloat(ethers.formatEther(newBalanceWei)).toFixed(6);
                                updateWalletBalanceChart();
                            } catch (balanceUpdateError) {
                                log(`Failed to update balance for ...${walletInfo.address.slice(-6)}: ${balanceUpdateError.message}`, 'warning');
                            }

                            if (i < actionsForWallet && !appState.stopFlag) {
                                let currentMinDelay = appState.config.minDelay;
                                let currentMaxDelay = appState.config.maxDelay;

                                // NEW: Time-of-Day Bias
                                if (appState.config.enableTimeOfDayBias) {
                                    const currentHour = new Date().getHours();
                                    // Reduce activity during simulated night hours (e.g., 1 AM to 6 AM)
                                    if (currentHour >= 1 && currentHour < 6) {
                                        currentMinDelay *= 2; // Double min delay
                                        currentMaxDelay *= 2; // Double max delay
                                        log(`Applying time-of-day bias: increased delay due to night hours.`, 'info');
                                    }
                                }

                                // NEW: Think Time Bursts
                                if (Math.random() * 100 < appState.config.thinkTimeChance) {
                                    delayUsed = Stealth.generateLogNormalDelay(appState.config.minThinkTime, appState.config.maxThinkTime);
                                    log(`Waiting for a human-like "think time" burst of ${Math.round(delayUsed/1000)} seconds...`, 'info');
                                    appState.lastHumanLikeSpike = new Date().toLocaleTimeString();
                                    ui.humanSpikeDisplay.textContent = appState.lastHumanLikeSpike;
                                    await sleep(delayUsed);
                                } else {
                                    delayUsed = Stealth.generateLogNormalDelay(currentMinDelay, currentMaxDelay);
                                    log(`Waiting for ${Math.round(delayUsed/1000)} seconds before next action...`, 'info', { delayUsedMs: delayUsed });
                                    await sleep(delayUsed);
                                }
                            }
                        } // End of actionsForWallet loop

                        if (appState.stopFlag) break; // Break main loop if stop requested during inner loop

                        // NEW: Lull period after an activity burst
                        if (currentSessionType === 'burst' && appState.config.minLullTime > 0) {
                            const lullDelay = Stealth.generateLogNormalDelay(appState.config.minLullTime, appState.config.maxLullTime);
                            log(`Activity burst completed. Entering lull period for ${Math.round(lullDelay/1000)} seconds...`, 'info');
                            appState.lastHumanLikeSpike = new Date().toLocaleTimeString();
                            ui.humanSpikeDisplay.textContent = appState.lastHumanLikeSpike;
                            await sleep(lullDelay);
                        } else {
                            // Original session delay, if not a burst session
                            const sessionDelay = Stealth.generateLogNormalDelay(appState.config.minDelay, appState.config.maxDelay);
                            log(`Session for Wallet ...${walletAddress.slice(-6)} on Chain ID ${chainId} completed. Waiting for ${Math.round(sessionDelay/1000)} seconds before next session...`, 'info', { delayUsedMs: sessionDelay });
                            await sleep(sessionDelay);
                        }
                    } // End of while (appState.isRunning && !appState.stopFlag)
                    log('Interaction process finished.', 'success');
                    stopInteraction();
                });
            };

            const stopInteraction = () => {
                appState.isRunning = false;
                appState.stopFlag = true;
                ui.startBtn.disabled = false;
                ui.stopBtn.disabled = true;
                ui.statusDisplay.textContent = 'Idle';
            };

            const clearAllData = () => {
                openConfirmationModal('Are you sure you want to clear ALL configurations, loaded wallets, and log data? This action cannot be undone.', (confirmed) => {
                    if (confirmed) {
                        appState.isRunning = false;
                        appState.stopFlag = false;
                        appState.wallets = [];
                        appState.rpcConfigs = [];
                        appState.currentRecipientPool = {};
                        appState.manualRecipientList = [];
                        ui.listAddresses.value = '';
                        ui.listAddressesCount.textContent = '';
                        appState.predefinedRecipientList = [];
                        ui.predefinedFileInput.value = '';
                        ui.predefinedAddressesInfo.textContent = 'No file loaded.';
                        updatePredefinedAddressesDisplay();
                        appState.config = {};
                        // Updated appState.stats reset for all action types
                        appState.stats = { totalActions: 0, successfulActions: 0, failedActions: 0, actionCounts: { send: 0, deploy: 0, interact: 0, idle: 0, 'balance-check': 0, skipped: 0 } };
                        appState.logEntries = [];
                        appState.lastHumanLikeSpike = null;
                        ui.humanSpikeDisplay.textContent = 'Never';

                        ui.privateKeys.value = '';
                        // Reset all config fields by re-injecting defaults
                        injectStealthDefaults();
                        ui.stealthProfileSelector.value = "balanced"; // Reset profile selector

                        // Clear contract memory from localStorage
                        walletChainContracts = {};
                        localStorage.removeItem(CONTRACT_STORAGE_KEY);
                        log('Contract memory cleared from local storage.', 'info');

                        setUIEnabled(false);
                        // Re-initialize console charts after clearing data to ensure they reflect the empty state correctly
                        initConsoleCharts();
                        updateWalletBalanceChart(); // Ensure wallet balance chart is empty
                    }
                });
            };

            const handleExplainSendTx = async () => {
                const minAmount = ui.minAmount.value;
                const maxAmount = ui.maxAmount.value;
                const recipientMode = Array.from(ui.recipientMode).find(r => r.checked).value;
                const fixedAddress = ui.fixedAddress.value.trim();
                const listAddressCount = appState.manualRecipientList.length;
                const predefinedAddressCount = appState.predefinedRecipientList.length;
                const loadedWalletCount = appState.wallets.length;


                let recipientDescription = '';
                if (recipientMode === 'fixed' && fixedAddress) {
                    recipientDescription = `a fixed address (${fixedAddress.substring(0, 6)}...)`;
                } else if (recipientMode === 'list' && listAddressCount > 0) {
                    recipientDescription = `a random address from a custom list of ${listAddressCount} addresses`;
                } else if (recipientMode === 'predefined' && predefinedAddressCount > 0) {
                    recipientDescription = `a random address from a predefined list of ${predefinedAddressCount} addresses`;
                } else if (recipientMode === 'self-interact' && loadedWalletCount > 1) {
                    recipientDescription = `a random address from the other ${loadedWalletCount - 1} loaded wallets (excluding the sender)`;
                }
                else {
                    recipientDescription = 'a random address from a dynamically scanned pool (with fallback to loaded wallets if no external addresses are found)';
                }

                const prompt = `I am setting up a script to send Ethereum. The amount will be between ${minAmount} and ${maxAmount} ETH. The recipient will be ${recipientDescription}. Explain the typical purpose of such transactions in a blockchain context and any general risks a user should be aware of.`;
                await callGeminiApi(prompt);
            };

            // NEW: handleSummarizeLog function
            const handleSummarizeLog = async () => {
                if (appState.logEntries.length === 0) {
                    openGeminiModal('No Log Data', '<p class="text-accent">There are no log entries to summarize yet. Start Interaction to generate logs!</p>');
                    return;
                }

                // Take the last 100 log entries to avoid sending excessively large prompts
                const recentLogEntries = appState.logEntries.slice(-100);
                const formattedLog = recentLogEntries.map(entry => {
                    return `${entry.Timestamp} [${entry.Status}] ${entry.Action} - ${entry.Details}`;
                }).join('\n');

                const prompt = `Please summarize the following blockchain transaction log. Identify key events, common patterns (e.g., successful transactions, repeated errors), and any notable observations. If there are errors, categorize them if possible.
                --- Log Data ---
                ${formattedLog}
                --- End Log Data ---
                Provide a concise summary and any insights you can derive.`;

                await callGeminiApi(prompt);
            };


            const downloadLogCsv = () => {
                if (appState.logEntries.length === 0) {
                    openGeminiModal('No Data', '<p class="text-accent">No log data to download.</p>');
                    return;
                }

                const headers = Object.keys(appState.logEntries[0]).join(',');
                const rows = appState.logEntries.map(entry =>
                    Object.values(entry).map(value => `"${String(value).replace(/"/g, '""')}"`).join(',')
                );

                const csvContent = headers + '\n' + rows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `tx_log_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                log('Log downloaded as CSV.', 'info');
            };

            const downloadLogJson = () => {
                if (appState.logEntries.length === 0) {
                    openGeminiModal('No Data', '<p class="text-accent">No log data to download.</p>');
                    return;
                }

                const jsonContent = JSON.stringify(appState.logEntries, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `tx_log_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                log('Log downloaded as JSON.', 'info');
            };

            const clearLog = () => {
                openConfirmationModal('Are you sure you want to clear the live log? This will remove all displayed and stored log entries.', (confirmed) => {
                    if (confirmed) {
                        ui.liveLog.innerHTML = '';
                        appState.logEntries = [];
                        log('Live log cleared.', 'info');
                    }
                });
            };

            const copyToClipboard = (text) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'absolute';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    log(`Copied "${text}" to clipboard.`, 'info');
                } catch (err) {
                    log('Failed to copy to clipboard (unsupported by browser/iframe).', 'error');
                }
                document.body.removeChild(textarea);
            };

            const connectWallet = async () => {
                if (typeof window.ethereum === 'undefined') {
                    log('MetaMask or compatible wallet not detected. Please install one.', 'error');
                    ui.walletStatusDisplay.innerHTML = `No wallet detected. Please install <a href="https://metamask.io/" target="_blank" class="underline text-blue-500">MetaMask</a> or a compatible browser extension.`;
                    setUIEnabled(false); // Disable other features as no wallet is connected
                    return;
                }

                log('window.ethereum detected. Requesting accounts...', 'info');
                ui.walletStatusDisplay.innerHTML = 'Connecting... (Check your wallet extension for a pop-up)'; // Inform user to look for pop-up
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

                    if (accounts.length === 0) {
                        log('No accounts found. Please connect your wallet and select an account.', 'error');
                        appState.connectedAddress = null;
                        ui.walletStatusDisplay.innerHTML = `No wallet connected.`;
                        setUIEnabled(false);
                        return;
                    }
                    appState.connectedAddress = accounts[0];
                    log(`Wallet connected: ${appState.connectedAddress}`, 'success');
                    ui.walletStatusDisplay.innerHTML = `Connected: <strong>${appState.connectedAddress.slice(0, 6)}...${appState.connectedAddress.slice(-4)}</strong>`;
                    setUIEnabled(true); // Enable all features now that a wallet is connected

                    // Set up event listeners for window.ethereum
                    window.ethereum.on('accountsChanged', (newAccounts) => {
                        log('Wallet accounts changed event detected.', 'info');
                        if (newAccounts.length === 0) {
                            log('Wallet disconnected or no accounts selected.', 'warning');
                            appState.connectedAddress = null;
                            ui.walletStatusDisplay.innerHTML = `No wallet connected.`;
                            setUIEnabled(false);
                        } else if (appState.connectedAddress && newAccounts[0].toLowerCase() !== appState.connectedAddress.toLowerCase()) {
                            log(`Account changed to: ${newAccounts[0]}`, 'info');
                            appState.connectedAddress = newAccounts[0];
                            ui.walletStatusDisplay.innerHTML = `Connected: <strong>${appState.connectedAddress.slice(0, 6)}...${appState.connectedAddress.slice(-4)}</strong>`;
                            setUIEnabled(true);
                        } else if (!appState.connectedAddress) {
                            log(`Wallet reconnected with account: ${newAccounts[0]}`, 'info');
                            appState.connectedAddress = newAccounts[0];
                            ui.walletStatusDisplay.innerHTML = `Connected: <strong>${appState.connectedAddress.slice(0, 6)}...${appState.connectedAddress.slice(-4)}</strong>`;
                            setUIEnabled(true);
                        }
                    });

                    window.ethereum.on('chainChanged', (chainId) => {
                        log(`Network changed to Chain ID: ${parseInt(chainId, 16)}. Please ensure your RPC configurations match this network.`, 'warning');
                    });

                    window.ethereum.on('disconnect', (error) => {
                        log(`Wallet disconnected: ${error.message || 'Unknown error'}`, 'error');
                        appState.connectedAddress = null;
                        ui.walletStatusDisplay.innerHTML = `No wallet connected.`;
                        setUIEnabled(false);
                    });

                } catch (error) {
                    log(`Wallet connection failed: ${error.message}`, 'error');
                    appState.connectedAddress = null;
                    ui.walletStatusDisplay.innerHTML = `Connection failed.`;
                    setUIEnabled(false);
                }
            };

            const setupEventListeners = () => {
                ui.connectWalletBtn.addEventListener('click', connectWallet);
                ui.startBtn.addEventListener('click', startInteraction);
                ui.stopBtn.addEventListener('click', stopInteraction);
                ui.clearAllDataBtn.addEventListener('click', clearAllData);
                ui.exportContractMemoryBtn.addEventListener('click', exportContractMemory); // NEW
                ui.importContractMemoryBtn.addEventListener('click', () => ui.importContractMemoryInput.click()); // Trigger hidden input click
                ui.importContractMemoryInput.addEventListener('change', importContractMemory); // Handle file selection
                ui.loadKeysBtn.addEventListener('click', loadWallets);
                ui.testRpcBtn.addEventListener('click', testRpcConnections);
                ui.downloadLogCsvBtn.addEventListener('click', downloadLogCsv); // NEW
                ui.downloadLogJsonBtn.addEventListener('click', downloadLogJson); // NEW
                ui.clearLogBtn.addEventListener('click', clearLog); // NEW
                ui.summarizeLogBtn.addEventListener('click', handleSummarizeLog); // NEW event listener
                ui.explainSendTxBtn.addEventListener('click', handleExplainSendTx);
                ui.loadAddressesFromListBtn.addEventListener('click', loadAddressesFromList);
                ui.loadPredefinedFileBtn.addEventListener('click', loadPredefinedListFromFile);

                ui.closeModalBtn.addEventListener('click', closeGeminiModal);
                window.addEventListener('click', (event) => {
                    if (event.target === ui.geminiModal) {
                        closeGeminiModal();
                    }
                });

                ui.confirmActionBtn.addEventListener('click', confirmAction);
                ui.cancelConfirmBtn.addEventListener('click', cancelAction);
                ui.closeConfirmBtn.addEventListener('click', cancelAction);
                window.addEventListener('click', (event) => {
                    if (event.target === ui.confirmationModal) {
                        cancelAction();
                    }
                });

                ui.liveLog.addEventListener('click', (event) => {
                    const copyBtn = event.target.closest('.log-copy-btn');
                    if (copyBtn && copyBtn.dataset.txHash) {
                        copyToClipboard(copyBtn.dataset.txHash);
                    }
                });


                ui.recipientMode.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        ui.fixedAddressSection.classList.toggle('hidden', e.target.value !== 'fixed');
                        ui.listAddressesSection.classList.toggle('hidden', e.target.value !== 'list');
                        ui.predefinedAddressesSection.classList.toggle('hidden', e.target.value !== 'predefined');
                        loadConfiguration();
                    });
                });

                // Only attach event listeners to relevant probability inputs
                document.querySelectorAll('#prob-send, #prob-deploy, #prob-interact, #prob-idle-action, #prob-balance-check').forEach(input => {
                    input.addEventListener('input', loadConfiguration);
                });

                ui.minAmount.addEventListener('input', loadConfiguration);
                ui.maxAmount.addEventListener('input', loadConfiguration);
                ui.minDelay.addEventListener('input', loadConfiguration);
                ui.maxDelay.addEventListener('input', loadConfiguration);
                ui.gasMultiplier.addEventListener('input', loadConfiguration);
                ui.minGasFactor.addEventListener('input', loadConfiguration);
                ui.maxGasFactor.addEventListener('input', loadConfiguration);
                ui.blockLookback.addEventListener('input', loadConfiguration);
                ui.probJitterFactor.addEventListener('input', loadConfiguration); // NEW
                ui.simulatedErrorChance.addEventListener('input', loadConfiguration); // NEW
                ui.thinkTimeChance.addEventListener('input', loadConfiguration); // NEW
                ui.minThinkTime.addEventListener('input', loadConfiguration); // NEW
                ui.maxThinkTime.addEventListener('input', loadConfiguration); // NEW
                ui.activityBurstChance.addEventListener('input', loadConfiguration); // NEW
                ui.minBurstActions.addEventListener('input', loadConfiguration); // NEW
                ui.maxBurstActions.addEventListener('input', loadConfiguration); // NEW
                ui.minLullTime.addEventListener('input', loadConfiguration); // NEW
                ui.maxLullTime.addEventListener('input', loadConfiguration); // NEW
                ui.enableTimeOfDayBias.addEventListener('change', loadConfiguration); // NEW
                ui.rpcSwitchDelay.addEventListener('input', loadConfiguration); // NEW
                ui.walletSwitchDelay.addEventListener('input', loadConfiguration); // NEW
                ui.apiKeyInput.addEventListener('input', loadConfiguration); // NEW

                // Event listener for Stealth Profile Selector
                ui.stealthProfileSelector.addEventListener("change", (e) => {
                    const selected = e.target.value;
                    if (selected !== "custom") {
                        applyProfile(selected);
                    }
                });
                
                // Submenu toggle functionality
                ui.advanceConsoleToggle.addEventListener('click', () => {
                    ui.advanceConsoleToggle.classList.toggle('active');
                    ui.advanceConsoleSubmenu.classList.toggle('open');
                });

                // Handle navigation links for internal sections
                document.querySelectorAll('#sidebar .nav-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        // For external links, let the browser handle it
                        if (this.getAttribute('href') && !this.getAttribute('href').startsWith('#')) {
                            return;
                        }
                        e.preventDefault();
                        
                        // Handle active states
                        document.querySelectorAll('#sidebar .nav-link, #sidebar .submenu-toggle').forEach(el => el.classList.remove('active'));
                        
                        const parentSubmenu = this.closest('.submenu');
                        if (parentSubmenu) {
                            // It's a submenu link, make the toggle active
                            parentSubmenu.previousElementSibling.classList.add('active');
                        } else {
                            // It's a top-level link
                             this.classList.add('active');
                        }
                        
                        const targetId = this.getAttribute('href').substring(1);
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });
                });

                // Dark Mode Toggle Logic
                ui.themeToggle.addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    const isDarkMode = document.documentElement.classList.contains('dark');
                    localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                    ui.themeToggleIcon.classList.toggle('fa-sun', isDarkMode);
                    ui.themeToggleIcon.classList.toggle('fa-moon', !isDarkMode);
                    // Re-initialize charts to update colors based on new theme
                    initConsoleCharts();
                    updateWalletBalanceChart();
                    // Trigger a dummy update to refresh action chart colors, if needed
                    // This might be redundant if initConsoleCharts already resets data
                    // For now, let's just ensure the chart is updated with current (likely zero) stats
                    updateActionDistChart('send'); 
                });

                // Apply saved theme on load
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                    ui.themeToggleIcon.classList.add('fa-sun');
                    ui.themeToggleIcon.classList.remove('fa-moon');
                } else {
                    document.documentElement.classList.remove('dark');
                    ui.themeToggleIcon.classList.add('fa-moon');
                    ui.themeToggleIcon.classList.remove('fa-sun');
                }
            };

            initConsoleCharts(); // Initialize charts for the console
            setupEventListeners();
            loadConfiguration(); // Load initial configuration values from UI elements
            updateWalletBalanceChart(); // Initial chart update (will be empty)
            setUIEnabled(false); // Initially disable features, but connect wallet button remains enabled

            // Set the initial active navigation link for Dashboard by default
            const initialActiveToggle = document.getElementById('advance-console-toggle');
            initialActiveToggle.classList.add('active');
            initialActiveToggle.nextElementSibling.classList.add('open');


            // Initial check for window.ethereum and existing connection on page load
            if (typeof window.ethereum !== 'undefined') {
                 log('MetaMask or compatible wallet detected on startup. Checking for existing connection...', 'info');
                 window.ethereum.request({ method: 'eth_accounts' })
                    .then(accounts => {
                        if (accounts.length > 0) {
                            appState.connectedAddress = accounts[0];
                            log(`Existing wallet connection found: ${appState.connectedAddress}`, 'info');
                            ui.walletStatusDisplay.innerHTML = `Connected: <strong>${appState.connectedAddress.slice(0, 6)}...${appState.connectedAddress.slice(-4)}</strong>`;
                            setUIEnabled(true);
                        } else {
                             ui.walletStatusDisplay.innerHTML = `No wallet connected.`;
                             log('No existing wallet connection found on startup.', 'info');
                             setUIEnabled(false); // Ensure features are disabled if no existing connection
                        }
                    })
                    .catch(error => {
                        log(`Error checking existing wallet connection: ${error.message}`, 'error');
                         ui.walletStatusDisplay.innerHTML = `Error: ${error.message}`;
                         setUIEnabled(false); // Ensure features are disabled on error
                    });

                 window.ethereum.on('accountsChanged', (newAccounts) => {
                     log('Wallet accounts changed event detected (startup listener).', 'info');
                     if (newAccounts.length === 0) {
                         log('Wallet disconnected or no accounts selected (startup listener).', 'warning');
                         appState.connectedAddress = null;
                         ui.walletStatusDisplay.innerHTML = `No wallet connected.`;
                         setUIEnabled(false);
                     } else {
                         log(`Account changed to: ${newAccounts[0]} (startup listener)`, 'info');
                         appState.connectedAddress = newAccounts[0];
                         ui.walletStatusDisplay.innerHTML = `Connected: <strong>${appState.connectedAddress.slice(0, 6)}...${appState.connectedAddress.slice(-4)}</strong>`;
                         setUIEnabled(true);
                     }
                 });

                 window.ethereum.on('chainChanged', (chainId) => {
                     log(`Network changed to Chain ID: ${parseInt(chainId, 16)} (startup listener). Please ensure RPCs match.`, 'warning');
                 });

                 window.ethereum.on('disconnect', (error) => {
                    log(`Wallet disconnected: ${error.message || 'Unknown error'} (startup listener)`, 'error');
                    appState.connectedAddress = null;
                    ui.walletStatusDisplay.innerHTML = `No wallet connected.`;
                    setUIEnabled(false);
                });

            } else {
                ui.walletStatusDisplay.innerHTML = `No wallet detected. Please install <a href="https://metamask.io/" target="_blank" class="underline text-blue-500">MetaMask</a>.`;
                log('MetaMask or compatible wallet not detected on startup.', 'error');
                setUIEnabled(false); // Ensure features are disabled if MetaMask is not detected
            }

            log('Console initialized. Please connect your wallet to begin.');

            // --- NEW FOOTER FUNCTIONALITY ---
            const donationAddressStr = '0x1C46ccEA4D62d3eEC4DCE3501aa96d0Ff5FcA954';
            const copyBtn = document.getElementById('copy-address-btn');
            const copyIcon = document.getElementById('copy-icon');
            const checkIcon = document.getElementById('check-icon'); // Ensure checkIcon is defined
            checkIcon.classList.add('hidden'); // Ensure check icon is hidden initially
            const showQrBtn = document.getElementById('show-qr-btn');
            const qrModal = document.getElementById('qr-code-modal');
            const closeQrModalBtn = qrModal.querySelector('.close-qr-button');
            const qrCodeContainer = document.getElementById('qr-code-container');
            const qrAddressDisplay = document.getElementById('qr-address-display');

            // Initialize QR Code once
            if(typeof QRCode !== 'undefined') {
                new QRCode(qrCodeContainer, {
                    text: donationAddressStr,
                    width: 200,
                    height: 200,
                    colorDark : "#2d3748",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
                qrAddressDisplay.textContent = donationAddressStr;
            } else {
                console.error("QRCode library is not loaded.")
                qrCodeContainer.innerHTML = "QR Code library failed to load. Please check your connection.";
            }

            // Copy to clipboard
            copyBtn.addEventListener('click', () => {
                copyToClipboard(donationAddressStr);
                copyIcon.classList.add('hidden');
                checkIcon.classList.remove('hidden');
                setTimeout(() => {
                    copyIcon.classList.remove('hidden');
                    checkIcon.classList.add('hidden');
                }, 2000);
            });

            // Show QR Modal
            showQrBtn.addEventListener('click', () => {
                qrModal.classList.remove('hidden');
            });

            // Close QR Modal logic
            const closeQrModal = () => {
                qrModal.classList.add('hidden');
            }
            closeQrModalBtn.addEventListener('click', closeQrModal);
            window.addEventListener('click', (event) => {
                if (event.target === qrModal) {
                    closeQrModal();
                }
            });
        });
    </script>
</body>
</html>
	
